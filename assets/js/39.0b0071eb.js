(window.webpackJsonp=window.webpackJsonp||[]).push([[39],{655:function(s,n,a){"use strict";a.r(n);var e=a(7),t=Object(e.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("p",[a("img",{attrs:{src:"https://atlas.pingcode.com/files/public/62374c3d0768d614e2cbff90",alt:"image.png"}})])]),s._v(" "),a("p"),a("div",{staticClass:"table-of-contents"},[a("ul",[a("li",[a("a",{attrs:{href:"#一、sidecar-cr"}},[s._v("一、Sidecar CR")]),a("ul",[a("li",[a("a",{attrs:{href:"#_7-1、sidecar配置"}},[s._v("7.1、Sidecar配置")])]),a("li",[a("a",{attrs:{href:"#_7-2、sidecar配置示例"}},[s._v("7.2、Sidecar配置示例")])]),a("li",[a("a",{attrs:{href:"#_7-2-2、sidecar配置示例-定义可被访问的出站服务"}},[s._v("7.2.2、Sidecar配置示例 - 定义可被访问的出站服务")])])])])])]),a("p"),s._v(" "),a("p",[a("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/a876ce53880f048106d1ffedd8ae71a2.png",alt:"⭐️关注我 ，一起探索更多知识！⭐️"}})]),s._v(" "),a("p",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=Mzg3NzY0NjY5OQ==&mid=2247484127&idx=1&sn=d819cfded9102b9a16d8a58070d75ac7&chksm=cf1e84dbf8690dcde5d2c47d4073b0a0aaa79b57521a845b2d387fb063bab8ab4e6cad991754#rd",target:"_blank",rel:"noopener noreferrer"}},[s._v("ServiceMesh基本概念"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=Mzg3NzY0NjY5OQ==&mid=2247484137&idx=1&sn=65fbe4f279521a4d0de75692719b7475&chksm=cf1e84edf8690dfb9c6adf7788c77613e1f3776b47547a281860f627f2ea5077f7ef8cb97a45#rd",target:"_blank",rel:"noopener noreferrer"}},[s._v("手把手教你部署istio控制平面"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=Mzg3NzY0NjY5OQ==&mid=2247484163&idx=1&sn=d0d4eaab73dc8e950e46a789e4f40fb3&chksm=cf1e8507f8690c112fb75c5b99558eb15e4e8de9bf89e166bcd15304c74f7b55bedb97c8b77e&token=414749856&lang=zh_CN#rd",target:"_blank",rel:"noopener noreferrer"}},[s._v("四个案例让你掌握istio网格功能"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=Mzg3NzY0NjY5OQ==&mid=2247484245&idx=1&sn=859b0808beebc3fe660bc398ce4ffc68&chksm=cf1e8551f8690c47d435732e654890c105644d57d5175c01f74f892d0a6cdcb23db120c3c1bd#rd",target:"_blank",rel:"noopener noreferrer"}},[s._v("VirtualService实现Istio高级流量治理"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"http://mp.weixin.qq.com/s?__biz=Mzg3NzY0NjY5OQ==&mid=2247484270&idx=1&sn=bce9568d5782b15bf718257ade445918&chksm=cf1e856af8690c7cffce92758098cebf68e15759859e54ec040e9bc26b79afe250fda320b44b&token=729952560&lang=zh_CN#rd",target:"_blank",rel:"noopener noreferrer"}},[s._v("DestinationRule实现Istio集群高级配置"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://mp.weixin.qq.com/s?__biz=Mzg3NzY0NjY5OQ==&mid=2247484296&idx=1&sn=e21a7f2e4eb6ddac513f14afb9fcfef8&chksm=cf1e858cf8690c9ae0703833ed3568a28c5c6f38ffc7954efd67f692bdbbfaab2b1e9589d66c#rd",target:"_blank",rel:"noopener noreferrer"}},[s._v("Sidecar及流量拦截机制-上"),a("OutboundLink")],1)]),s._v(" "),a("h2",{attrs:{id:"一、sidecar-cr"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#一、sidecar-cr"}},[s._v("#")]),s._v(" 一、Sidecar CR")]),s._v(" "),a("ul",[a("li",[a("p",[s._v("由于在网格当中每一个以任何一个Pod为视角的该istio proxy 都会配置了到达该网格内任何服务的 Egress Listener的相关配置，因此可能会带来以下的问题 ：")]),s._v(" "),a("ul",[a("li",[s._v("导致任何一个Pod对应的 istio proxy 配置信息量过大，而且可能更多的目标服务并不能正常访问到，并且微服务架构中本身一个需要联系的服务并不会很多；")]),s._v(" "),a("li",[s._v("所以我们需要配置特定的一组Pod中的istio-proxy上可用的Listener的专用CR；")])])]),s._v(" "),a("li",[a("p",[s._v("Sidecar CR")]),s._v(" "),a("ul",[a("li",[s._v("默认情况下，istio会配置每一个Sidecar Envoy能够与同一网格内所有的workload实例通信，并且能够在与其代理的workload相关的所有端口上接收流量；")]),s._v(" "),a("li",[s._v("从实际通信需求来说，网格内的每个workload未必需要同当前网格内的所有其它workload通信，于是，sidecar CR提供了为 sidecar Envoy 微调其用于 workload间通信时支持的端口集和协议等配置的方式；")]),s._v(" "),a("li",[s._v("另外，转发来自其代理的 workload实例的出向流量时，Sidecar CR资源对象还能够限制Sidecar Envoy可以访问的外部服务集；")])])]),s._v(" "),a("li",[a("p",[s._v("Sidecar CR的生效机制")]),s._v(" "),a("ul",[a("li",[s._v("Sidecar CR通过 workloadSelector字段挑选同一名称空间中的一个或多个 workload实例来应用其提供的配置；")]),s._v(" "),a("li",[s._v("对于未提供workloadSelector字段Sidecar资源，其配置将应用于同一名称空间下中的所有workload实例(默认)；")]),s._v(" "),a("li",[s._v("namespace中同时存在带有workloadSelector字段以及为附带此字段的Sidecar资源对象时，workload实例将优先应用带有此字段的Sidecar对象；")]),s._v(" "),a("li",[s._v("每个namespace中仅应该提供一个未附带workloadSelector字段的Sidecar资源，否则其配置结果将难以确定；")]),s._v(" "),a("li",[s._v("另外，每个workload也应该仅应用一个带有workloadSelector字段的Sidecar资源，否则其行为同样难以明确；")])])])]),s._v(" "),a("h3",{attrs:{id:"_7-1、sidecar配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-1、sidecar配置"}},[s._v("#")]),s._v(" 7.1、Sidecar配置")]),s._v(" "),a("ul",[a("li",[s._v("outboundTrafficPolicy - mode - (REGISTRY_ONLY|ALLOW_ANY)")]),s._v(" "),a("li",[s._v("IstioIngressListener (并非创建ingress listener，而是用来生成filter chain match条件的)")]),s._v(" "),a("li",[s._v("IstioEgressListener (port和bind则是用来定义 egress listener，并且使用hosts指明主机头来适配的流量)\n"),a("ul",[a("li",[s._v("captureMode : 流量捕获、拦截机制\n"),a("ul",[a("li",[s._v("DEFAULT : 默认")]),s._v(" "),a("li",[s._v("IPTABLES : iptables")]),s._v(" "),a("li",[s._v("NODE : 不拦截，直接向后发送")])])])])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("root@native:~# kubectl explain sidecar.spec\nKIND:     Sidecar\nVERSION:  networking.istio.io/v1beta1\n\nRESOURCE: spec <Object>\n\nDESCRIPTION:\n     Configuration affecting network reachability of a sidecar. See more details\n     at: https://istio.io/docs/reference/config/networking/sidecar.html\n\nFIELDS:\n   # 配置出站方向的侦听器\n   egress    <[]Object>\n   # 配置入站方向的侦听器\n   ingress    <[]Object>\n\n   # 对于所有的出站方向的侦听器，没能匹配到与之相对应请求的目标相关联流量时，可以使用outboundTrafficPolicy来定义出向请求的处理方式(ALLOW_ANY | REGISTRY_ONLY)\n   outboundTrafficPolicy    <Object>\n     Configuration for the outbound traffic policy.\n\n   # workloadSelector 是否存在决定定义的此策略是针对一组还是一部分Pod生效\n   workloadSelector    <Object>\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("h3",{attrs:{id:"_7-2、sidecar配置示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2、sidecar配置示例"}},[s._v("#")]),s._v(" 7.2、Sidecar配置示例")]),s._v(" "),a("h4",{attrs:{id:"_7-2-1、环境准备"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-1、环境准备"}},[s._v("#")]),s._v(" 7.2.1、环境准备")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://atlas.pingcode.com/files/public/6237489c56ba176c0d89cfde",alt:"image.png"}})]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('1、部署demoapp v10\n# cat 01-demoapp-v10/deploy-demoapp.yaml\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: demoappv10\n    version: v1.0\n  name: demoappv10\nspec:\n  progressDeadlineSeconds: 600\n  replicas: 3\n  selector:\n    matchLabels:\n      app: demoapp\n      version: v1.0\n  template:\n    metadata:\n      labels:\n        app: demoapp\n        version: v1.0\n    spec:\n      containers:\n      - image: registry.cn-wulanchabu.aliyuncs.com/daizhe/demoapp:v1.0\n        imagePullPolicy: IfNotPresent\n        name: demoapp\n        env:\n        - name: "PORT"\n          value: "8080"\n        ports:\n        - containerPort: 8080\n          name: web\n          protocol: TCP\n        resources:\n          limits:\n            cpu: 50m\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: demoappv10\nspec:\n  ports:\n    - name: http\n      port: 8080\n      protocol: TCP\n      targetPort: 8080\n  selector:\n    app: demoapp\n    version: v1.0\n  type: ClusterIP\n---\n\n2、部署demoapp v11\n# cat 02-demoapp-v11/deploy-demoapp-v11.yaml\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: demoappv11\n    version: v1.1\n  name: demoappv11\nspec:\n  progressDeadlineSeconds: 600\n  replicas: 2\n  selector:\n    matchLabels:\n      app: demoapp\n      version: v1.1\n  template:\n    metadata:\n      labels:\n        app: demoapp\n        version: v1.1\n    spec:\n      containers:\n      - image: registry.cn-wulanchabu.aliyuncs.com/daizhe/demoapp:v1.1\n        imagePullPolicy: IfNotPresent\n        name: demoapp\n        env:\n        - name: "PORT"\n          value: "8080"\n        ports:\n        - containerPort: 8080\n          name: web\n          protocol: TCP\n        resources:\n          limits:\n            cpu: 50m\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: demoappv11\nspec:\n  ports:\n    - name: http-8080\n      port: 8080\n      protocol: TCP\n      targetPort: 8080\n  selector:\n    app: demoapp\n    version: v1.1\n  type: ClusterIP\n---\n\n3、部署proxy\n# cat 02-demoapp-v11/deploy-proxy.yaml\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: proxy\nspec:\n  progressDeadlineSeconds: 600\n  replicas: 1\n  selector:\n    matchLabels:\n      app: proxy\n  template:\n    metadata:\n      labels:\n        app: proxy\n    spec:\n      containers:\n        - env:\n          - name: PROXYURL\n            value: http://demoapp:8080\n          image: registry.cn-wulanchabu.aliyuncs.com/daizhe/proxy:v0.1.1\n          imagePullPolicy: IfNotPresent\n          name: proxy\n          ports:\n            - containerPort: 8080\n              name: web\n              protocol: TCP\n          resources:\n            limits:\n              cpu: 50m\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: proxy\nspec:\n  ports:\n    - name: http-80\n      port: 80\n      protocol: TCP\n      targetPort: 8080\n  selector:\n    app: proxy\n---\n\n4、定义匹配到demoapp v10 和 v11 的service （v10和v11各自的service可以不定义）\n# cat 02-demoapp-v11/service-demoapp.yaml\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: demoapp\nspec:\n  ports:\n    - name: http\n      port: 8080\n      protocol: TCP\n      targetPort: 8080\n  selector:\n    app: demoapp\n  type: ClusterIP\n---\n\n5、创建定义的demoapp subset 子集\n# cat 03-demoapp-subset/virutalservice-demoapp.yaml\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: demoapp\nspec:\n  hosts:\n  - demoapp\n  http:\n  - name: canary\n    match:\n    - uri:\n        prefix: /canary\n    rewrite:\n      uri: /\n    route:\n    - destination:\n        host: demoapp\n        subset: v11\n  - name: default\n    route:\n    - destination:\n        host: demoapp\n        subset: v10\n\n# cat 03-demoapp-subset/destinationrule-demoapp.yaml\napiVersion: networking.istio.io/v1beta1\nkind: DestinationRule\nmetadata:\n  name: demoapp\nspec:\n  host: demoapp\n  subsets:\n  - name: v10\n    labels:\n      version: v1.0\n  - name: v11\n    labels:\n      version: v1.1\n\n6、开放proxy 使用gateway暴露proxy服务\n# cat  04-proxy-gateway/virtualservice-proxy.yaml\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: proxy\nspec:\n  hosts:\n  - "fe.toptops.top"                     # 对应于gateways/proxy-gateway\n  gateways:\n  - istio-system/proxy-gateway       # 相关定义仅应用于Ingress Gateway上\n  #- mesh\n  http:\n  - name: default\n    route:\n    - destination:\n        host: proxy\n# cat  04-proxy-gateway/gateway-proxy.yaml\napiVersion: networking.istio.io/v1beta1\nkind: Gateway\nmetadata:\n  name: proxy-gateway\n  namespace: istio-system        # 要指定为ingress gateway pod所在名称空间\nspec:\n  selector:\n    app: istio-ingressgateway\n  servers:\n  - port:\n      number: 80\n      name: http\n      protocol: HTTP\n    hosts:\n    - "fe.toptops.top"\n\n7、创建demoapp 调度策略\n# cat  06-weight-based-routing/virtualservice-demoapp.yaml\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: demoapp\nspec:\n  hosts:\n  - demoapp\n  http:\n  - name: weight-based-routing\n    route:\n    - destination:\n        host: demoapp\n        subset: v10\n      weight: 90\n    - destination:\n        host: demoapp\n        subset: v11\n      weight: 10\n\n# kubectl get gateway -n istio-system\nNAME              AGE\ngrafana-gateway   8d\nkiali-gateway     8d\nproxy-gateway     29s\n\n# kubectl get vs\nNAME      GATEWAYS                         HOSTS                AGE\ndemoapp                                    ["demoapp"]          110s\nproxy     ["istio-system/proxy-gateway"]   ["fe.toptops.top"]   42s\n\n# kubectl get dr\nNAME      HOST      AGE\ndemoapp   demoapp   80s\n\n# kubectl delete svc demoappv10 demoappv11\nservice "demoappv10" deleted\nservice "demoappv11" deleted\n\n# 以下Service一定会在网格中生成对应的 Listener、VirtualHost、Route、Destination\n# kubectl get svc\nNAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\ndemoapp      ClusterIP   10.100.75.191    <none>        8080/TCP   87m\nkubernetes   ClusterIP   10.100.0.1       <none>        443/TCP    8d\nproxy        ClusterIP   10.100.154.127   <none>        80/TCP     7d12h\n\n8、访问测试(网格内启动客户端进行访问测试)\n# kubectl run client --image=registry.cn-wulanchabu.aliyuncs.com/daizhe/admin-box -it --rm --restart=Never --command -- /bin/sh\nIf you don\'t see a command prompt, try pressing enter.\n\nroot@native:~# kubectl get pods\nNAME                          READY   STATUS    RESTARTS   AGE\nclient                        2/2     Running   0          93s\ndemoappv10-6ff964cbff-84kqr   2/2     Running   0          7d12h\ndemoappv10-6ff964cbff-ngpr9   2/2     Running   0          7d12h\ndemoappv10-6ff964cbff-t6mxd   2/2     Running   0          7d12h\ndemoappv11-7984f579f5-8m7ng   2/2     Running   0          92m\ndemoappv11-7984f579f5-mx9kf   2/2     Running   0          92m\nproxy-6b567ff76f-kf852        2/2     Running   0          92m\n\n# 需要注意的是 ：在网格当中运行应用程序是应该会显式使用两个标签 ，app和version 并且每个Pod必须要隶属于某个Service，很显然client两个条件都没有满足，所有并没有遵循网格服务的使用规范，但这里的client仅作为客户端测试使用；\nroot@client # curl localhost:15000/listeners\n6a8a0b6e-c652-4edd-b5b1-3d210fb0a8ae::0.0.0.0:15090\n316502d0-d131-4ea6-87f3-e7df91014c00::0.0.0.0:15021\n10.100.146.158_15443::10.100.146.158:15443\n10.100.0.1_443::10.100.0.1:443\n10.100.0.2_53::10.100.0.2:53\n10.100.146.158_443::10.100.146.158:443\n10.100.146.158_31400::10.100.146.158:31400\n10.100.136.102_443::10.100.136.102:443\n10.100.136.102_15012::10.100.136.102:15012\n10.100.167.188_443::10.100.167.188:443\n10.100.166.70_3000::10.100.166.70:3000\n0.0.0.0_15010::0.0.0.0:15010\n0.0.0.0_15014::0.0.0.0:15014\n0.0.0.0_20001::0.0.0.0:20001\n10.100.0.2_9153::10.100.0.2:9153\n0.0.0.0_9411::0.0.0.0:9411\n0.0.0.0_9090::0.0.0.0:9090\n0.0.0.0_16685::0.0.0.0:16685\n0.0.0.0_8080::0.0.0.0:8080\n0.0.0.0_80::0.0.0.0:80\n10.100.22.254_14268::10.100.22.254:14268\n10.100.22.254_14250::10.100.22.254:14250\n10.100.146.158_15021::10.100.146.158:15021\nvirtualOutbound::0.0.0.0:15001\nvirtualInbound::0.0.0.0:15006\n\nroot@native:~# istioctl proxy-config  listeners client\nroot@native:~# kubectl exec -it client -c istio-proxy -- pilot-agent request GET /listeners\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br"),a("span",{staticClass:"line-number"},[s._v("94")]),a("br"),a("span",{staticClass:"line-number"},[s._v("95")]),a("br"),a("span",{staticClass:"line-number"},[s._v("96")]),a("br"),a("span",{staticClass:"line-number"},[s._v("97")]),a("br"),a("span",{staticClass:"line-number"},[s._v("98")]),a("br"),a("span",{staticClass:"line-number"},[s._v("99")]),a("br"),a("span",{staticClass:"line-number"},[s._v("100")]),a("br"),a("span",{staticClass:"line-number"},[s._v("101")]),a("br"),a("span",{staticClass:"line-number"},[s._v("102")]),a("br"),a("span",{staticClass:"line-number"},[s._v("103")]),a("br"),a("span",{staticClass:"line-number"},[s._v("104")]),a("br"),a("span",{staticClass:"line-number"},[s._v("105")]),a("br"),a("span",{staticClass:"line-number"},[s._v("106")]),a("br"),a("span",{staticClass:"line-number"},[s._v("107")]),a("br"),a("span",{staticClass:"line-number"},[s._v("108")]),a("br"),a("span",{staticClass:"line-number"},[s._v("109")]),a("br"),a("span",{staticClass:"line-number"},[s._v("110")]),a("br"),a("span",{staticClass:"line-number"},[s._v("111")]),a("br"),a("span",{staticClass:"line-number"},[s._v("112")]),a("br"),a("span",{staticClass:"line-number"},[s._v("113")]),a("br"),a("span",{staticClass:"line-number"},[s._v("114")]),a("br"),a("span",{staticClass:"line-number"},[s._v("115")]),a("br"),a("span",{staticClass:"line-number"},[s._v("116")]),a("br"),a("span",{staticClass:"line-number"},[s._v("117")]),a("br"),a("span",{staticClass:"line-number"},[s._v("118")]),a("br"),a("span",{staticClass:"line-number"},[s._v("119")]),a("br"),a("span",{staticClass:"line-number"},[s._v("120")]),a("br"),a("span",{staticClass:"line-number"},[s._v("121")]),a("br"),a("span",{staticClass:"line-number"},[s._v("122")]),a("br"),a("span",{staticClass:"line-number"},[s._v("123")]),a("br"),a("span",{staticClass:"line-number"},[s._v("124")]),a("br"),a("span",{staticClass:"line-number"},[s._v("125")]),a("br"),a("span",{staticClass:"line-number"},[s._v("126")]),a("br"),a("span",{staticClass:"line-number"},[s._v("127")]),a("br"),a("span",{staticClass:"line-number"},[s._v("128")]),a("br"),a("span",{staticClass:"line-number"},[s._v("129")]),a("br"),a("span",{staticClass:"line-number"},[s._v("130")]),a("br"),a("span",{staticClass:"line-number"},[s._v("131")]),a("br"),a("span",{staticClass:"line-number"},[s._v("132")]),a("br"),a("span",{staticClass:"line-number"},[s._v("133")]),a("br"),a("span",{staticClass:"line-number"},[s._v("134")]),a("br"),a("span",{staticClass:"line-number"},[s._v("135")]),a("br"),a("span",{staticClass:"line-number"},[s._v("136")]),a("br"),a("span",{staticClass:"line-number"},[s._v("137")]),a("br"),a("span",{staticClass:"line-number"},[s._v("138")]),a("br"),a("span",{staticClass:"line-number"},[s._v("139")]),a("br"),a("span",{staticClass:"line-number"},[s._v("140")]),a("br"),a("span",{staticClass:"line-number"},[s._v("141")]),a("br"),a("span",{staticClass:"line-number"},[s._v("142")]),a("br"),a("span",{staticClass:"line-number"},[s._v("143")]),a("br"),a("span",{staticClass:"line-number"},[s._v("144")]),a("br"),a("span",{staticClass:"line-number"},[s._v("145")]),a("br"),a("span",{staticClass:"line-number"},[s._v("146")]),a("br"),a("span",{staticClass:"line-number"},[s._v("147")]),a("br"),a("span",{staticClass:"line-number"},[s._v("148")]),a("br"),a("span",{staticClass:"line-number"},[s._v("149")]),a("br"),a("span",{staticClass:"line-number"},[s._v("150")]),a("br"),a("span",{staticClass:"line-number"},[s._v("151")]),a("br"),a("span",{staticClass:"line-number"},[s._v("152")]),a("br"),a("span",{staticClass:"line-number"},[s._v("153")]),a("br"),a("span",{staticClass:"line-number"},[s._v("154")]),a("br"),a("span",{staticClass:"line-number"},[s._v("155")]),a("br"),a("span",{staticClass:"line-number"},[s._v("156")]),a("br"),a("span",{staticClass:"line-number"},[s._v("157")]),a("br"),a("span",{staticClass:"line-number"},[s._v("158")]),a("br"),a("span",{staticClass:"line-number"},[s._v("159")]),a("br"),a("span",{staticClass:"line-number"},[s._v("160")]),a("br"),a("span",{staticClass:"line-number"},[s._v("161")]),a("br"),a("span",{staticClass:"line-number"},[s._v("162")]),a("br"),a("span",{staticClass:"line-number"},[s._v("163")]),a("br"),a("span",{staticClass:"line-number"},[s._v("164")]),a("br"),a("span",{staticClass:"line-number"},[s._v("165")]),a("br"),a("span",{staticClass:"line-number"},[s._v("166")]),a("br"),a("span",{staticClass:"line-number"},[s._v("167")]),a("br"),a("span",{staticClass:"line-number"},[s._v("168")]),a("br"),a("span",{staticClass:"line-number"},[s._v("169")]),a("br"),a("span",{staticClass:"line-number"},[s._v("170")]),a("br"),a("span",{staticClass:"line-number"},[s._v("171")]),a("br"),a("span",{staticClass:"line-number"},[s._v("172")]),a("br"),a("span",{staticClass:"line-number"},[s._v("173")]),a("br"),a("span",{staticClass:"line-number"},[s._v("174")]),a("br"),a("span",{staticClass:"line-number"},[s._v("175")]),a("br"),a("span",{staticClass:"line-number"},[s._v("176")]),a("br"),a("span",{staticClass:"line-number"},[s._v("177")]),a("br"),a("span",{staticClass:"line-number"},[s._v("178")]),a("br"),a("span",{staticClass:"line-number"},[s._v("179")]),a("br"),a("span",{staticClass:"line-number"},[s._v("180")]),a("br"),a("span",{staticClass:"line-number"},[s._v("181")]),a("br"),a("span",{staticClass:"line-number"},[s._v("182")]),a("br"),a("span",{staticClass:"line-number"},[s._v("183")]),a("br"),a("span",{staticClass:"line-number"},[s._v("184")]),a("br"),a("span",{staticClass:"line-number"},[s._v("185")]),a("br"),a("span",{staticClass:"line-number"},[s._v("186")]),a("br"),a("span",{staticClass:"line-number"},[s._v("187")]),a("br"),a("span",{staticClass:"line-number"},[s._v("188")]),a("br"),a("span",{staticClass:"line-number"},[s._v("189")]),a("br"),a("span",{staticClass:"line-number"},[s._v("190")]),a("br"),a("span",{staticClass:"line-number"},[s._v("191")]),a("br"),a("span",{staticClass:"line-number"},[s._v("192")]),a("br"),a("span",{staticClass:"line-number"},[s._v("193")]),a("br"),a("span",{staticClass:"line-number"},[s._v("194")]),a("br"),a("span",{staticClass:"line-number"},[s._v("195")]),a("br"),a("span",{staticClass:"line-number"},[s._v("196")]),a("br"),a("span",{staticClass:"line-number"},[s._v("197")]),a("br"),a("span",{staticClass:"line-number"},[s._v("198")]),a("br"),a("span",{staticClass:"line-number"},[s._v("199")]),a("br"),a("span",{staticClass:"line-number"},[s._v("200")]),a("br"),a("span",{staticClass:"line-number"},[s._v("201")]),a("br"),a("span",{staticClass:"line-number"},[s._v("202")]),a("br"),a("span",{staticClass:"line-number"},[s._v("203")]),a("br"),a("span",{staticClass:"line-number"},[s._v("204")]),a("br"),a("span",{staticClass:"line-number"},[s._v("205")]),a("br"),a("span",{staticClass:"line-number"},[s._v("206")]),a("br"),a("span",{staticClass:"line-number"},[s._v("207")]),a("br"),a("span",{staticClass:"line-number"},[s._v("208")]),a("br"),a("span",{staticClass:"line-number"},[s._v("209")]),a("br"),a("span",{staticClass:"line-number"},[s._v("210")]),a("br"),a("span",{staticClass:"line-number"},[s._v("211")]),a("br"),a("span",{staticClass:"line-number"},[s._v("212")]),a("br"),a("span",{staticClass:"line-number"},[s._v("213")]),a("br"),a("span",{staticClass:"line-number"},[s._v("214")]),a("br"),a("span",{staticClass:"line-number"},[s._v("215")]),a("br"),a("span",{staticClass:"line-number"},[s._v("216")]),a("br"),a("span",{staticClass:"line-number"},[s._v("217")]),a("br"),a("span",{staticClass:"line-number"},[s._v("218")]),a("br"),a("span",{staticClass:"line-number"},[s._v("219")]),a("br"),a("span",{staticClass:"line-number"},[s._v("220")]),a("br"),a("span",{staticClass:"line-number"},[s._v("221")]),a("br"),a("span",{staticClass:"line-number"},[s._v("222")]),a("br"),a("span",{staticClass:"line-number"},[s._v("223")]),a("br"),a("span",{staticClass:"line-number"},[s._v("224")]),a("br"),a("span",{staticClass:"line-number"},[s._v("225")]),a("br"),a("span",{staticClass:"line-number"},[s._v("226")]),a("br"),a("span",{staticClass:"line-number"},[s._v("227")]),a("br"),a("span",{staticClass:"line-number"},[s._v("228")]),a("br"),a("span",{staticClass:"line-number"},[s._v("229")]),a("br"),a("span",{staticClass:"line-number"},[s._v("230")]),a("br"),a("span",{staticClass:"line-number"},[s._v("231")]),a("br"),a("span",{staticClass:"line-number"},[s._v("232")]),a("br"),a("span",{staticClass:"line-number"},[s._v("233")]),a("br"),a("span",{staticClass:"line-number"},[s._v("234")]),a("br"),a("span",{staticClass:"line-number"},[s._v("235")]),a("br"),a("span",{staticClass:"line-number"},[s._v("236")]),a("br"),a("span",{staticClass:"line-number"},[s._v("237")]),a("br"),a("span",{staticClass:"line-number"},[s._v("238")]),a("br"),a("span",{staticClass:"line-number"},[s._v("239")]),a("br"),a("span",{staticClass:"line-number"},[s._v("240")]),a("br"),a("span",{staticClass:"line-number"},[s._v("241")]),a("br"),a("span",{staticClass:"line-number"},[s._v("242")]),a("br"),a("span",{staticClass:"line-number"},[s._v("243")]),a("br"),a("span",{staticClass:"line-number"},[s._v("244")]),a("br"),a("span",{staticClass:"line-number"},[s._v("245")]),a("br"),a("span",{staticClass:"line-number"},[s._v("246")]),a("br"),a("span",{staticClass:"line-number"},[s._v("247")]),a("br"),a("span",{staticClass:"line-number"},[s._v("248")]),a("br"),a("span",{staticClass:"line-number"},[s._v("249")]),a("br"),a("span",{staticClass:"line-number"},[s._v("250")]),a("br"),a("span",{staticClass:"line-number"},[s._v("251")]),a("br"),a("span",{staticClass:"line-number"},[s._v("252")]),a("br"),a("span",{staticClass:"line-number"},[s._v("253")]),a("br"),a("span",{staticClass:"line-number"},[s._v("254")]),a("br"),a("span",{staticClass:"line-number"},[s._v("255")]),a("br"),a("span",{staticClass:"line-number"},[s._v("256")]),a("br"),a("span",{staticClass:"line-number"},[s._v("257")]),a("br"),a("span",{staticClass:"line-number"},[s._v("258")]),a("br"),a("span",{staticClass:"line-number"},[s._v("259")]),a("br"),a("span",{staticClass:"line-number"},[s._v("260")]),a("br"),a("span",{staticClass:"line-number"},[s._v("261")]),a("br"),a("span",{staticClass:"line-number"},[s._v("262")]),a("br"),a("span",{staticClass:"line-number"},[s._v("263")]),a("br"),a("span",{staticClass:"line-number"},[s._v("264")]),a("br"),a("span",{staticClass:"line-number"},[s._v("265")]),a("br"),a("span",{staticClass:"line-number"},[s._v("266")]),a("br"),a("span",{staticClass:"line-number"},[s._v("267")]),a("br"),a("span",{staticClass:"line-number"},[s._v("268")]),a("br"),a("span",{staticClass:"line-number"},[s._v("269")]),a("br"),a("span",{staticClass:"line-number"},[s._v("270")]),a("br"),a("span",{staticClass:"line-number"},[s._v("271")]),a("br"),a("span",{staticClass:"line-number"},[s._v("272")]),a("br"),a("span",{staticClass:"line-number"},[s._v("273")]),a("br"),a("span",{staticClass:"line-number"},[s._v("274")]),a("br"),a("span",{staticClass:"line-number"},[s._v("275")]),a("br"),a("span",{staticClass:"line-number"},[s._v("276")]),a("br"),a("span",{staticClass:"line-number"},[s._v("277")]),a("br"),a("span",{staticClass:"line-number"},[s._v("278")]),a("br"),a("span",{staticClass:"line-number"},[s._v("279")]),a("br"),a("span",{staticClass:"line-number"},[s._v("280")]),a("br"),a("span",{staticClass:"line-number"},[s._v("281")]),a("br"),a("span",{staticClass:"line-number"},[s._v("282")]),a("br"),a("span",{staticClass:"line-number"},[s._v("283")]),a("br"),a("span",{staticClass:"line-number"},[s._v("284")]),a("br"),a("span",{staticClass:"line-number"},[s._v("285")]),a("br"),a("span",{staticClass:"line-number"},[s._v("286")]),a("br"),a("span",{staticClass:"line-number"},[s._v("287")]),a("br"),a("span",{staticClass:"line-number"},[s._v("288")]),a("br"),a("span",{staticClass:"line-number"},[s._v("289")]),a("br"),a("span",{staticClass:"line-number"},[s._v("290")]),a("br"),a("span",{staticClass:"line-number"},[s._v("291")]),a("br"),a("span",{staticClass:"line-number"},[s._v("292")]),a("br"),a("span",{staticClass:"line-number"},[s._v("293")]),a("br"),a("span",{staticClass:"line-number"},[s._v("294")]),a("br"),a("span",{staticClass:"line-number"},[s._v("295")]),a("br"),a("span",{staticClass:"line-number"},[s._v("296")]),a("br"),a("span",{staticClass:"line-number"},[s._v("297")]),a("br"),a("span",{staticClass:"line-number"},[s._v("298")]),a("br"),a("span",{staticClass:"line-number"},[s._v("299")]),a("br"),a("span",{staticClass:"line-number"},[s._v("300")]),a("br"),a("span",{staticClass:"line-number"},[s._v("301")]),a("br"),a("span",{staticClass:"line-number"},[s._v("302")]),a("br"),a("span",{staticClass:"line-number"},[s._v("303")]),a("br"),a("span",{staticClass:"line-number"},[s._v("304")]),a("br"),a("span",{staticClass:"line-number"},[s._v("305")]),a("br"),a("span",{staticClass:"line-number"},[s._v("306")]),a("br"),a("span",{staticClass:"line-number"},[s._v("307")]),a("br"),a("span",{staticClass:"line-number"},[s._v("308")]),a("br"),a("span",{staticClass:"line-number"},[s._v("309")]),a("br"),a("span",{staticClass:"line-number"},[s._v("310")]),a("br"),a("span",{staticClass:"line-number"},[s._v("311")]),a("br"),a("span",{staticClass:"line-number"},[s._v("312")]),a("br"),a("span",{staticClass:"line-number"},[s._v("313")]),a("br"),a("span",{staticClass:"line-number"},[s._v("314")]),a("br"),a("span",{staticClass:"line-number"},[s._v("315")]),a("br"),a("span",{staticClass:"line-number"},[s._v("316")]),a("br"),a("span",{staticClass:"line-number"},[s._v("317")]),a("br"),a("span",{staticClass:"line-number"},[s._v("318")]),a("br"),a("span",{staticClass:"line-number"},[s._v("319")]),a("br"),a("span",{staticClass:"line-number"},[s._v("320")]),a("br"),a("span",{staticClass:"line-number"},[s._v("321")]),a("br"),a("span",{staticClass:"line-number"},[s._v("322")]),a("br"),a("span",{staticClass:"line-number"},[s._v("323")]),a("br"),a("span",{staticClass:"line-number"},[s._v("324")]),a("br"),a("span",{staticClass:"line-number"},[s._v("325")]),a("br"),a("span",{staticClass:"line-number"},[s._v("326")]),a("br"),a("span",{staticClass:"line-number"},[s._v("327")]),a("br"),a("span",{staticClass:"line-number"},[s._v("328")]),a("br"),a("span",{staticClass:"line-number"},[s._v("329")]),a("br"),a("span",{staticClass:"line-number"},[s._v("330")]),a("br"),a("span",{staticClass:"line-number"},[s._v("331")]),a("br"),a("span",{staticClass:"line-number"},[s._v("332")]),a("br"),a("span",{staticClass:"line-number"},[s._v("333")]),a("br"),a("span",{staticClass:"line-number"},[s._v("334")]),a("br"),a("span",{staticClass:"line-number"},[s._v("335")]),a("br"),a("span",{staticClass:"line-number"},[s._v("336")]),a("br"),a("span",{staticClass:"line-number"},[s._v("337")]),a("br"),a("span",{staticClass:"line-number"},[s._v("338")]),a("br")])]),a("p"),s._v(" "),a("h3",{attrs:{id:"_7-2-2、sidecar配置示例-定义可被访问的出站服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-2、sidecar配置示例-定义可被访问的出站服务"}},[s._v("#")]),s._v(" 7.2.2、Sidecar配置示例 - 定义可被访问的出站服务")]),s._v(" "),a("h4",{attrs:{id:"_7-2-2-1、outboundtrafficpolicy-registry-only-丢弃"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-2-1、outboundtrafficpolicy-registry-only-丢弃"}},[s._v("#")]),s._v(" 7.2.2.1、outboundTrafficPolicy : REGISTRY_ONLY 丢弃")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('1、创建sidecar\n# kubectl get pods --show-labels\nNAME                          READY   STATUS    RESTARTS   AGE     LABELS\nclient                        2/2     Running   0          21m     run=client,security.istio.io/tlsMode=istio,service.istio.io/canonical-name=client,service.istio.io/canonical-revision=latest\n\n# cat  sidecar-demo.yaml\napiVersion: networking.istio.io/v1beta1\nkind: Sidecar\nmetadata:\n  name: client\n  namespace: default\nspec:\n  # 定义workload实例\n  workloadSelector:\n    # 标签匹配的Pod run=client\n    labels:\n      run: client\n  # 若不存在可接收转发报文的Listener，流量直接丢弃\n  outboundTrafficPolicy:\n    mode: REGISTRY_ONLY\n  # 定义出站侦听器\n  egress:\n  # 定义允许所匹配的实例所访问的服务，仅client允许访问demoapp的HTTP协议的8080端口\n  - port:\n      number: 8080\n      protocol: HTTP\n      name: demoapp\n    # 当前名称空间下可以使用所有名称\n    hosts:\n    - "./*"\n\n# kubectl apply -f sidecar-demo.yaml\nsidecar.networking.istio.io/client created\n# kubectl get sidecar\nNAME     AGE\nclient   6s\n\n2、验证client之上可用的侦听器，已经被急剧压缩\nroot@client # curl localhost:15000/listeners\n6a8a0b6e-c652-4edd-b5b1-3d210fb0a8ae::0.0.0.0:15090\n316502d0-d131-4ea6-87f3-e7df91014c00::0.0.0.0:15021\n0.0.0.0_8080::0.0.0.0:8080\nvirtualOutbound::0.0.0.0:15001\nvirtualInbound::0.0.0.0:15006\n\n3、访问测试，此时只能访问demoapp service 8080端口\nroot@client # curl demoapp:8080\niKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-6ff964cbff-ngpr9, ServerIP: 10.220.158.84!\nroot@client # curl proxy:80\ncurl: (56) Recv failure: Connection reset by peer\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br")])]),a("p"),s._v(" "),a("h4",{attrs:{id:"_7-2-2-2、outboundtrafficpolicy-allow-any-透传"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-2-2、outboundtrafficpolicy-allow-any-透传"}},[s._v("#")]),s._v(" 7.2.2.2、outboundTrafficPolicy : ALLOW_ANY 透传")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('1、创建sidecar\n# kubectl get pods --show-labels\nNAME                          READY   STATUS    RESTARTS   AGE     LABELS\nclient                        2/2     Running   0          21m     run=client,security.istio.io/tlsMode=istio,service.istio.io/canonical-name=client,service.istio.io/canonical-revision=latest\n\n# cat  sidecar-demo.yaml\napiVersion: networking.istio.io/v1beta1\nkind: Sidecar\nmetadata:\n  name: client\n  namespace: default\nspec:\n  # 定义workload实例\n  workloadSelector:\n    # 标签匹配的Pod run=client\n    labels:\n      run: client\n  # 若不存在可接收转发报文的Listener，流量透传\n  outboundTrafficPolicy:\n    # mode: REGISTRY_ONLY\n    mode: ALLOW_ANY\n  # 定义出站侦听器\n  egress:\n  # 定义允许所匹配的实例所访问的服务，仅client允许访问demoapp的HTTP协议的8080端口\n  - port:\n      number: 8080\n      protocol: HTTP\n      name: demoapp\n    # 当前名称空间下可以使用所有名称\n    hosts:\n    - "./*"\n\n# kubectl apply -f sidecar-demo.yaml\nsidecar.networking.istio.io/client created\n# kubectl get sidecar\nNAME     AGE\nclient   6s\n\n2、验证client之上可用的侦听器，已经被急剧压缩\nroot@client # curl localhost:15000/listeners\n6a8a0b6e-c652-4edd-b5b1-3d210fb0a8ae::0.0.0.0:15090\n316502d0-d131-4ea6-87f3-e7df91014c00::0.0.0.0:15021\n0.0.0.0_8080::0.0.0.0:8080\nvirtualOutbound::0.0.0.0:15001\nvirtualInbound::0.0.0.0:15006\n\n3、访问测试，虽然指定定义了client出向demoapp出站侦听器，但是由于设置的若不存在可接收转发报文的Listener，流量透传，所以也可以透传达到proxy；\nroot@client # curl demoapp:8080\niKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-6ff964cbff-84kqr, ServerIP: 10.220.158.81!\nroot@client # curl proxy:80\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-6ff964cbff-84kqr, ServerIP: 10.220.158.81!\n - Took 63 milliseconds.\n\nroot@client # while true; do curl proxy:80; curl demoapp:8080; sleep 0.$RANDOM; done\n...\n...\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br")])]),a("p"),s._v(" "),a("ul",[a("li",[s._v("kiali graph能够根据流量实时进行图形绘制 (访问proxy是透传)")])]),s._v(" "),a("p",[a("img",{attrs:{src:"https://atlas.pingcode.com/files/public/623749df0768d614e2cbff8b",alt:"image.png"}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://atlas.pingcode.com/files/public/623749ea0768d614e2cbff8c",alt:"image.png"}})]),s._v(" "),a("p")])}),[],!1,null,null,null);n.default=t.exports}}]);