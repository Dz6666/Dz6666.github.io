(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{656:function(s,n,e){"use strict";e.r(n);var a=e(7),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"title"}),e("p",[e("img",{attrs:{src:"https://atlas.pingcode.com/files/public/62309f4f628df6b38b6f1269",alt:"image.png"}})])]),s._v(" "),e("p"),e("div",{staticClass:"table-of-contents"},[e("ul",[e("li",[e("a",{attrs:{href:"#一、virtualservice-丰富路由控制"}},[s._v("一、VirtualService（丰富路由控制）")]),e("ul",[e("li",[e("a",{attrs:{href:"#_1-1、url重定向-redirect和rewrite"}},[s._v("1.1、URL重定向 (redirect和rewrite)")])]),e("li",[e("a",{attrs:{href:"#_1-2、流量分隔-基于权重的路由"}},[s._v("1.2、流量分隔 (基于权重的路由)")])]),e("li",[e("a",{attrs:{href:"#_1-3、headers-operation-操纵标头-请求报文-响应报文"}},[s._v("1.3、Headers Operation (操纵标头 -> 请求报文&响应报文)")])]),e("li",[e("a",{attrs:{href:"#_1-4、故障注入-测试服务韧性"}},[s._v("1.4、故障注入 (测试服务韧性)")])]),e("li",[e("a",{attrs:{href:"#_1-5、http-rerty-超时重试"}},[s._v("1.5、HTTP Rerty (超时重试)")])]),e("li",[e("a",{attrs:{href:"#_1-6、http-流量镜像"}},[s._v("1.6、HTTP 流量镜像")])])])])])]),e("p"),s._v(" "),e("h2",{attrs:{id:"一、virtualservice-丰富路由控制"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一、virtualservice-丰富路由控制"}},[s._v("#")]),s._v(" 一、VirtualService（丰富路由控制）")]),s._v(" "),e("h3",{attrs:{id:"_1-1、url重定向-redirect和rewrite"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-1、url重定向-redirect和rewrite"}},[s._v("#")]),s._v(" 1.1、URL重定向 (redirect和rewrite)")]),s._v(" "),e("ul",[e("li",[s._v("redirect ：即重定向。")]),s._v(" "),e("li",[s._v("rewrite ：即重写，不仅仅可以实现redirect在url上的重定向，还可以直接重写请求道实际的文件以及更多附加功能。")])]),s._v(" "),e("h4",{attrs:{id:"_1-1-1、案例示图"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-1、案例示图"}},[s._v("#")]),s._v(" 1.1.1、案例示图")]),s._v(" "),e("ul",[e("li",[s._v("proxy-gateway -> virtualservices/proxy -> virtualservices/demoapp(/backend) -> backend:8082 (Cluster)")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://atlas.pingcode.com/files/public/6215a7de9434be138adfb8d4",alt:"image.png"}})]),s._v(" "),e("h4",{attrs:{id:"_1-1-2、案例实验"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-2、案例实验"}},[s._v("#")]),s._v(" 1.1.2、案例实验")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('1、virtualservice 增加路由策略\n# cat virtualservice-demoapp.yaml\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: demoapp\nspec:\n  hosts:\n  - demoapp # hosts名称要和后端service名称所生成的默认路由保持一致 (需要和istioctl proxy-config routes $DEMOAPP的DOMAINS搜索域名称保持一致)\n  # 七层路由机制\n  http:\n  # rewrite 策略 : http://demoapp/canary -重写-> http://demoapp/\n  - name: rewrite\n    match:\n    - uri:\n        prefix: /canary\n    rewrite:\n      uri: /\n    # 路由目标\n    route:\n    # 调度给demoapp的clusters的v11子集\n    - destination:\n        host: demoapp\n        subset: v11\n  # redirect 策略 ： http://demoapp/backend -重定向-> http://demoapp/\n  - name: redirect\n    match:\n    - uri:\n        prefix: "/backend"\n    redirect:\n      uri: /\n      authority: backend    # 和destination 效果类似，所以也需要 backend service\n      port: 8082\n  - name: default\n    # 路由目标\n    route:\n    # 调度给demoapp的clusters的v10子集\n    - destination:\n        host: demoapp\n        subset: v10\n \n2、部署backend 服务\n# cat deploy-backend.yaml\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  labels:\n    app: backend\n    version: v3.6\n  name: backendv36\nspec:\n  progressDeadlineSeconds: 600\n  replicas: 2\n  selector:\n    matchLabels:\n      app: backend\n      version: v3.6\n  template:\n    metadata:\n      creationTimestamp: null\n      labels:\n        app: backend\n        version: v3.6\n    spec:\n      containers:\n      - image: registry.cn-wulanchabu.aliyuncs.com/daizhe/gowebserver:v0.1.0\n        imagePullPolicy: IfNotPresent\n        name: gowebserver\n        env:\n        - name: "SERVICE_NAME"\n          value: "backend"\n        - name: "SERVICE_PORT"\n          value: "8082"\n        - name: "SERVICE_VERSION"\n          value: "v3.6"\n        ports:\n        - containerPort: 8082\n          name: web\n          protocol: TCP\n        resources:\n          limits:\n            cpu: 50m\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: backend\nspec:\n  ports:\n    - name: http-web\n      port: 8082\n      protocol: TCP\n      targetPort: 8082\n  selector:\n    app: backend\n    version: v3.6\n\n# kubectl apply -f deploy-backend.yaml\ndeployment.apps/backendv36 created\nservice/backend created\n\n# kubectl get pods\nNAME                          READY   STATUS    RESTARTS   AGE\nbackendv36-64bd9dd97c-2qtcj   2/2     Running   0          7m47s\nbackendv36-64bd9dd97c-wmtd9   2/2     Running   0          7m47s\n...\n# kubectl get service\nNAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\nbackend      ClusterIP   10.100.168.13   <none>        8082/TCP   8m1s\n...\n\n\n3、proxy上查看路由策略\n# istioctl proxy-config routes proxy-6b567ff76f-27c4k | grep -E "demoapp|backend"\n                                                                        # backend 并不会真正显示重定向效果\n8082                                                                      backend, backend.default + 1 more...                 /*\n8080                                                                      demoapp, demoapp.default + 1 more...                 /canary*               demoapp.default\n8080                                                                      demoapp, demoapp.default + 1 more...                 /*                     demoapp.default\n80                                                                        demoapp.default.svc.cluster.local                    /canary*               demoapp.default\n80                                                                        demoapp.default.svc.cluster.local                    /*                     demoapp.default\n\n4、集群内client 访问 frontend proxy （补充 ：真正发挥网格流量调度的是 egress listener）\n# kubectl run client --image=registry.cn-wulanchabu.aliyuncs.com/daizhe/admin-box -it --rm --restart=Never --command -- /bin/sh\nIf you don\'t see a command prompt, try pressing enter.\nroot@client # curl proxy\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-fdwf4, ServerIP: 10.220.104.187!\n - Took 331 milliseconds.\nroot@client # curl proxy/canary\nProxying value: iKubernetes demoapp v1.1 !! ClientIP: 127.0.0.6, ServerName: demoappv11-7984f579f5-qsw5z, ServerIP: 10.220.104.166!\n - Took 40 milliseconds.\n# 真正定义客户访问backend路由是在demoapp上定义的，所以只有将url发送到后端去，后端才能实现重写策略，因此定义在哪个服务上才能对哪个服务进行请求；\nroot@client # curl proxy/backend\nProxying value: <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">\n<title>404 Not Found</title>\n<h1>Not Found</h1>\n<p>The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.</p>\n - Took 41 milliseconds.\n\n\n5、将 backend 路由重写策略定义 frontend proxy 上，定义适配到网格内部的proxy VirtualService (——> frontend proxy -重定向-> backend)\n# cat virtualservice-proxy.yaml\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: proxy\nspec:\n  hosts:\n  - proxy\n  http:\n  - name: redirect\n    match:\n    - uri:\n        prefix: "/backend"\n    redirect:\n      uri: /\n      authority: backend\n      port: 8082\n  - name: default\n    route:\n    - destination:\n        host: proxy\n\n# kubectl apply -f virtualservice-proxy.yaml\nvirtualservice.networking.istio.io/proxy configured\n\n# istioctl proxy-config routes proxy-6b567ff76f-27c4k | grep -E "demoapp|backend"\n8082                                                                      backend, backend.default + 1 more...                 /*\n8080                                                                      demoapp, demoapp.default + 1 more...                 /canary*               demoapp.default\n8080                                                                      demoapp, demoapp.default + 1 more...                 /*                     demoapp.default\n80                                                                        demoapp.default.svc.cluster.local                    /canary*               demoapp.default\n80                                                                        demoapp.default.svc.cluster.local                    /*                     demoapp.default\n80                                                                        proxy, proxy.default + 1 more...                     /backend*              proxy.default\n\n6、再次测试集群内client 访问 frontend proxy\n# kubectl run client --image=registry.cn-wulanchabu.aliyuncs.com/daizhe/admin-box -it --rm --restart=Never --command -- /bin/sh\nIf you don\'t see a command prompt, try pressing enter.\nroot@client # curl proxy\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-fdwf4, ServerIP: 10.220.104.187!\n - Took 331 milliseconds.\nroot@client # curl proxy/canary\nProxying value: iKubernetes demoapp v1.1 !! ClientIP: 127.0.0.6, ServerName: demoappv11-7984f579f5-qsw5z, ServerIP: 10.220.104.166!\nroot@client # curl -I  proxy/backend\nHTTP/1.1 301 Moved Permanently\nlocation: http://backend:8082/\ndate: Sat, 29 Jan 2022 04:32:08 GMT\nserver: envoy\ntransfer-encoding: chunked\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br"),e("span",{staticClass:"line-number"},[s._v("69")]),e("br"),e("span",{staticClass:"line-number"},[s._v("70")]),e("br"),e("span",{staticClass:"line-number"},[s._v("71")]),e("br"),e("span",{staticClass:"line-number"},[s._v("72")]),e("br"),e("span",{staticClass:"line-number"},[s._v("73")]),e("br"),e("span",{staticClass:"line-number"},[s._v("74")]),e("br"),e("span",{staticClass:"line-number"},[s._v("75")]),e("br"),e("span",{staticClass:"line-number"},[s._v("76")]),e("br"),e("span",{staticClass:"line-number"},[s._v("77")]),e("br"),e("span",{staticClass:"line-number"},[s._v("78")]),e("br"),e("span",{staticClass:"line-number"},[s._v("79")]),e("br"),e("span",{staticClass:"line-number"},[s._v("80")]),e("br"),e("span",{staticClass:"line-number"},[s._v("81")]),e("br"),e("span",{staticClass:"line-number"},[s._v("82")]),e("br"),e("span",{staticClass:"line-number"},[s._v("83")]),e("br"),e("span",{staticClass:"line-number"},[s._v("84")]),e("br"),e("span",{staticClass:"line-number"},[s._v("85")]),e("br"),e("span",{staticClass:"line-number"},[s._v("86")]),e("br"),e("span",{staticClass:"line-number"},[s._v("87")]),e("br"),e("span",{staticClass:"line-number"},[s._v("88")]),e("br"),e("span",{staticClass:"line-number"},[s._v("89")]),e("br"),e("span",{staticClass:"line-number"},[s._v("90")]),e("br"),e("span",{staticClass:"line-number"},[s._v("91")]),e("br"),e("span",{staticClass:"line-number"},[s._v("92")]),e("br"),e("span",{staticClass:"line-number"},[s._v("93")]),e("br"),e("span",{staticClass:"line-number"},[s._v("94")]),e("br"),e("span",{staticClass:"line-number"},[s._v("95")]),e("br"),e("span",{staticClass:"line-number"},[s._v("96")]),e("br"),e("span",{staticClass:"line-number"},[s._v("97")]),e("br"),e("span",{staticClass:"line-number"},[s._v("98")]),e("br"),e("span",{staticClass:"line-number"},[s._v("99")]),e("br"),e("span",{staticClass:"line-number"},[s._v("100")]),e("br"),e("span",{staticClass:"line-number"},[s._v("101")]),e("br"),e("span",{staticClass:"line-number"},[s._v("102")]),e("br"),e("span",{staticClass:"line-number"},[s._v("103")]),e("br"),e("span",{staticClass:"line-number"},[s._v("104")]),e("br"),e("span",{staticClass:"line-number"},[s._v("105")]),e("br"),e("span",{staticClass:"line-number"},[s._v("106")]),e("br"),e("span",{staticClass:"line-number"},[s._v("107")]),e("br"),e("span",{staticClass:"line-number"},[s._v("108")]),e("br"),e("span",{staticClass:"line-number"},[s._v("109")]),e("br"),e("span",{staticClass:"line-number"},[s._v("110")]),e("br"),e("span",{staticClass:"line-number"},[s._v("111")]),e("br"),e("span",{staticClass:"line-number"},[s._v("112")]),e("br"),e("span",{staticClass:"line-number"},[s._v("113")]),e("br"),e("span",{staticClass:"line-number"},[s._v("114")]),e("br"),e("span",{staticClass:"line-number"},[s._v("115")]),e("br"),e("span",{staticClass:"line-number"},[s._v("116")]),e("br"),e("span",{staticClass:"line-number"},[s._v("117")]),e("br"),e("span",{staticClass:"line-number"},[s._v("118")]),e("br"),e("span",{staticClass:"line-number"},[s._v("119")]),e("br"),e("span",{staticClass:"line-number"},[s._v("120")]),e("br"),e("span",{staticClass:"line-number"},[s._v("121")]),e("br"),e("span",{staticClass:"line-number"},[s._v("122")]),e("br"),e("span",{staticClass:"line-number"},[s._v("123")]),e("br"),e("span",{staticClass:"line-number"},[s._v("124")]),e("br"),e("span",{staticClass:"line-number"},[s._v("125")]),e("br"),e("span",{staticClass:"line-number"},[s._v("126")]),e("br"),e("span",{staticClass:"line-number"},[s._v("127")]),e("br"),e("span",{staticClass:"line-number"},[s._v("128")]),e("br"),e("span",{staticClass:"line-number"},[s._v("129")]),e("br"),e("span",{staticClass:"line-number"},[s._v("130")]),e("br"),e("span",{staticClass:"line-number"},[s._v("131")]),e("br"),e("span",{staticClass:"line-number"},[s._v("132")]),e("br"),e("span",{staticClass:"line-number"},[s._v("133")]),e("br"),e("span",{staticClass:"line-number"},[s._v("134")]),e("br"),e("span",{staticClass:"line-number"},[s._v("135")]),e("br"),e("span",{staticClass:"line-number"},[s._v("136")]),e("br"),e("span",{staticClass:"line-number"},[s._v("137")]),e("br"),e("span",{staticClass:"line-number"},[s._v("138")]),e("br"),e("span",{staticClass:"line-number"},[s._v("139")]),e("br"),e("span",{staticClass:"line-number"},[s._v("140")]),e("br"),e("span",{staticClass:"line-number"},[s._v("141")]),e("br"),e("span",{staticClass:"line-number"},[s._v("142")]),e("br"),e("span",{staticClass:"line-number"},[s._v("143")]),e("br"),e("span",{staticClass:"line-number"},[s._v("144")]),e("br"),e("span",{staticClass:"line-number"},[s._v("145")]),e("br"),e("span",{staticClass:"line-number"},[s._v("146")]),e("br"),e("span",{staticClass:"line-number"},[s._v("147")]),e("br"),e("span",{staticClass:"line-number"},[s._v("148")]),e("br"),e("span",{staticClass:"line-number"},[s._v("149")]),e("br"),e("span",{staticClass:"line-number"},[s._v("150")]),e("br"),e("span",{staticClass:"line-number"},[s._v("151")]),e("br"),e("span",{staticClass:"line-number"},[s._v("152")]),e("br"),e("span",{staticClass:"line-number"},[s._v("153")]),e("br"),e("span",{staticClass:"line-number"},[s._v("154")]),e("br"),e("span",{staticClass:"line-number"},[s._v("155")]),e("br"),e("span",{staticClass:"line-number"},[s._v("156")]),e("br"),e("span",{staticClass:"line-number"},[s._v("157")]),e("br"),e("span",{staticClass:"line-number"},[s._v("158")]),e("br"),e("span",{staticClass:"line-number"},[s._v("159")]),e("br"),e("span",{staticClass:"line-number"},[s._v("160")]),e("br"),e("span",{staticClass:"line-number"},[s._v("161")]),e("br"),e("span",{staticClass:"line-number"},[s._v("162")]),e("br"),e("span",{staticClass:"line-number"},[s._v("163")]),e("br"),e("span",{staticClass:"line-number"},[s._v("164")]),e("br"),e("span",{staticClass:"line-number"},[s._v("165")]),e("br"),e("span",{staticClass:"line-number"},[s._v("166")]),e("br"),e("span",{staticClass:"line-number"},[s._v("167")]),e("br"),e("span",{staticClass:"line-number"},[s._v("168")]),e("br"),e("span",{staticClass:"line-number"},[s._v("169")]),e("br"),e("span",{staticClass:"line-number"},[s._v("170")]),e("br"),e("span",{staticClass:"line-number"},[s._v("171")]),e("br"),e("span",{staticClass:"line-number"},[s._v("172")]),e("br"),e("span",{staticClass:"line-number"},[s._v("173")]),e("br"),e("span",{staticClass:"line-number"},[s._v("174")]),e("br"),e("span",{staticClass:"line-number"},[s._v("175")]),e("br"),e("span",{staticClass:"line-number"},[s._v("176")]),e("br"),e("span",{staticClass:"line-number"},[s._v("177")]),e("br"),e("span",{staticClass:"line-number"},[s._v("178")]),e("br"),e("span",{staticClass:"line-number"},[s._v("179")]),e("br"),e("span",{staticClass:"line-number"},[s._v("180")]),e("br"),e("span",{staticClass:"line-number"},[s._v("181")]),e("br"),e("span",{staticClass:"line-number"},[s._v("182")]),e("br"),e("span",{staticClass:"line-number"},[s._v("183")]),e("br"),e("span",{staticClass:"line-number"},[s._v("184")]),e("br"),e("span",{staticClass:"line-number"},[s._v("185")]),e("br"),e("span",{staticClass:"line-number"},[s._v("186")]),e("br"),e("span",{staticClass:"line-number"},[s._v("187")]),e("br"),e("span",{staticClass:"line-number"},[s._v("188")]),e("br")])]),e("p"),s._v(" "),e("h3",{attrs:{id:"_1-2、流量分隔-基于权重的路由"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2、流量分隔-基于权重的路由"}},[s._v("#")]),s._v(" 1.2、流量分隔 (基于权重的路由)")]),s._v(" "),e("h4",{attrs:{id:"_1-2-1、案例图示"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-1、案例图示"}},[s._v("#")]),s._v(" 1.2.1、案例图示")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://atlas.pingcode.com/files/public/6215ac4b490a0657f83229a2",alt:"image.png"}})]),s._v(" "),e("h4",{attrs:{id:"_1-2-2、案例实验"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-2、案例实验"}},[s._v("#")]),s._v(" 1.2.2、案例实验")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("1、定义 VirtualService\n# cat virtualservice-demoapp.yaml\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: demoapp\nspec:\n  # (demoapp 自动生成的虚拟主机做高级配置)，需要和istioctl proxy-config routes $DEMOAPP的DOMAINS搜索域名称保持一致\n  # 对demoapp service 服务的访问\n  hosts:\n  - demoapp\n  # 七层路由机制\n  http:\n  # 路由策略为列表项，可以设置为多个\n  # 路由名称，起一个名称\n  - name: weight-based-routing\n    # 路由目标  - 未设置match路由匹配条件，表示流量就在两个集群中进行轮换发送\n    route:\n    - destination:\n        host: demoapp   # 调度给demoapp的clusters的v10子集\n        subset: v10\n      weight: 90        # 承载权重 90% 流量\n    - destination:\n        host: demoapp   # 调度给demoapp的clusters的v11子集\n        subset: v11\n      weight: 10        # 承载权重 10% 流量\n\n# kubectl apply -f virtualservice-demoapp.yaml\nvirtualservice.networking.istio.io/demoapp created\n\n2、查看定义的 VS 是否生效\n# DEMOAPP=$(kubectl get pods -l app=demoapp -o jsonpath={.items[0].metadata.name})\n# echo $DEMOAPP\ndemoappv10-5c497c6f7c-24dk4\n# istioctl proxy-config routes $DEMOAPP | grep demoapp\n80                                                                        demoapp.default.svc.cluster.local                    /*                     demoapp.default\n8080                                                                      demoapp, demoapp.default + 1 more...                 /*                     demoapp.default\n\n3、client 访问 frontend proxy （补充 ：真正发挥网格流量调度的是 egress listener）\n# 9 : 1 的比例\n# kubectl run client --image=registry.cn-wulanchabu.aliyuncs.com/daizhe/admin-box -it --rm --restart=Never --command -- /bin/sh\nIf you don't see a command prompt, try pressing enter.\nroot@client # curl proxy\nProxying value: iKubernetes demoapp v1.1 !! ClientIP: 127.0.0.6, ServerName: demoappv11-7984f579f5-9bzmv, ServerIP: 10.220.104.177!\n - Took 230 milliseconds.\nroot@client # curl proxy\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-24dk4, ServerIP: 10.220.104.155!\n - Took 38 milliseconds.\nroot@client # curl proxy\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-ks5hk, ServerIP: 10.220.104.133!\n - Took 22 milliseconds.\nroot@client # curl proxy\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-fdwf4, ServerIP: 10.220.104.150!\n - Took 22 milliseconds.\nroot@client # curl proxy\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-24dk4, ServerIP: 10.220.104.155!\n - Took 15 milliseconds.\nroot@client # curl proxy\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-ks5hk, ServerIP: 10.220.104.133!\n - Took 6 milliseconds.\nroot@client # curl proxy\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-fdwf4, ServerIP: 10.220.104.150!\n - Took 13 milliseconds.\nroot@client # curl proxy\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-24dk4, ServerIP: 10.220.104.155!\n - Took 4 milliseconds.\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br")])]),e("ul",[e("li",[s._v("4、集群外部访问 proxy (9:1)")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://atlas.pingcode.com/files/public/6215ad009998feeb9ceef0a1",alt:"image.png"}})]),s._v(" "),e("p",[e("img",{attrs:{src:"https://atlas.pingcode.com/files/public/6215ad0a9998feeb9ceef0a2",alt:"image.png"}})]),s._v(" "),e("ul",[e("li",[s._v("5、kiali graph能够根据流量实时进行图形绘制 （样本足够大的情况下，流量比例就是 9 ：1）")])]),s._v(" "),e("blockquote",[e("p",[s._v("集群内部访问")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://atlas.pingcode.com/files/public/6215ad2d490a0657f83229ae",alt:"image.png"}})]),s._v(" "),e("blockquote",[e("p",[s._v("集群外部访问")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://atlas.pingcode.com/files/public/6215ad409434be138adfb935",alt:"image.png"}})]),s._v(" "),e("h3",{attrs:{id:"_1-3、headers-operation-操纵标头-请求报文-响应报文"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-3、headers-operation-操纵标头-请求报文-响应报文"}},[s._v("#")]),s._v(" 1.3、Headers Operation (操纵标头 -> 请求报文&响应报文)")]),s._v(" "),e("ul",[e("li",[s._v("Headers 为 Istio提供了操作 HTTP Header的途径，用于操作 HTTP 请求报文中 Request 或 Response 标头；\n"),e("ul",[e("li",[s._v("headers 字段支持 request和response两个内嵌字段；\n"),e("ul",[e("li",[s._v("request : 操纵发送给Destination 的请求报文中的标头；")]),s._v(" "),e("li",[s._v("response : 操纵发送给客户端的响应报文中的标头；")])])]),s._v(" "),e("li",[s._v("以上两个对应的类型都是 HeaderOperstions 类型，都支持使用\nset、add、remove\n字段操纵指定的标头 :\n"),e("ul",[e("li",[s._v("set : 使用map上的Key和Value覆盖Request或者Response中对应的Header；")]),s._v(" "),e("li",[s._v("add : 追加map上的Key和Value到原有 Header；")]),s._v(" "),e("li",[s._v("remove : 删除在列表中指定的Header；")])])])])])]),s._v(" "),e("h4",{attrs:{id:"_1-3-1、案例图示"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-1、案例图示"}},[s._v("#")]),s._v(" 1.3.1、案例图示")]),s._v(" "),e("ul",[e("li",[s._v("流量请求\n"),e("ul",[e("li",[s._v("Client <-> SidecarProxy Envoy <-> ServerPod")])])])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://atlas.pingcode.com/files/public/6215ad99490a0657f83229b6",alt:"image.png"}})]),s._v(" "),e("h4",{attrs:{id:"_1-3-2、案例实验"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-2、案例实验"}},[s._v("#")]),s._v(" 1.3.2、案例实验")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('1、定义 VirtualService 完成对demoapp service的请求报文&响应报文的操纵\n# cat virtualservice-demoapp.yaml\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: demoapp\nspec:\n  # 主机 ：对demoapp service 服务的访问\n  hosts:\n  - demoapp\n  # http 七层路由机制\n  http:\n  # 路由策略为列表项，可以设置为多个\n  # 路由名称，起一个名称\n  - name: canary\n    # 匹配条件\n    match:      # match匹配请求标头部分 : 如请求标头 x-canary: true的话则路由给 v11 子集，并操纵请求标头在请求报文当中修改 User-Agent: Chrome ，操纵响应标头增加 x-canary: true标头；\n    # 匹配请求标头条件\n    - headers:\n        x-canary:\n          exact: "true"\n    # 路由目标\n    route:\n    - destination:\n        host: demoapp\n        subset: v11\n      # 操纵标头\n      headers:\n        # 请求标头\n        request:\n          # 修改标头值\n          set:\n            User-Agent: Chrome\n        # 响应标头\n        response:\n          # 增加新标头\n          add:\n            x-canary: "true"\n  # 路由名称 : 标识为上述条件未匹配的默认路由，发送给 v10 子集；\n  - name: default\n    # 操纵标头 : 此处的定义位置生效范围表示发往所有default的路由目标都进行如下条件的响应报文操纵\n    headers:\n      # 响应标头\n      response:\n        # 操纵发从下游的响应标头增加 X-Envoy: test\n        add:\n          X-Envoy: test\n    # 路由目标\n    route:\n    - destination:\n        host: demoapp\n        subset: v10\n\n# kubectl apply -f virtualservice-demoapp.yaml\nvirtualservice.networking.istio.io/demoapp configured\n\n2、为了验证标头操纵，所以我们需要通过 client 直接向demoapp 发送请求\n# 模拟match的headers匹配条件，标头 x-canary: true的话则路由给demoapp  v11 子集\nroot@client /# curl -H "x-canary: true" demoapp:8080\niKubernetes demoapp v1.1 !! ClientIP: 127.0.0.6, ServerName: demoappv11-7984f579f5-msn2w, ServerIP: 10.220.104.159!\nroot@client /# curl -H "x-canary: true" demoapp:8080\niKubernetes demoapp v1.1 !! ClientIP: 127.0.0.6, ServerName: demoappv11-7984f579f5-9pm74, ServerIP: 10.220.104.164!\n# 查看响应头\nroot@client /# curl -I  -H "x-canary: true" demoapp:8080\nHTTP/1.1 200 OK\ncontent-type: text/html; charset=utf-8\ncontent-length: 116\nserver: envoy\ndate: Fri, 04 Feb 2022 05:49:44 GMT\nx-envoy-upstream-service-time: 2\nx-canary: true\n# 查看操作后的请求报文中浏览器类型\nroot@client /# curl -H "x-canary: true" demoapp:8080/user-agent\nUser-Agent: Chrome\n\n---\n\n# 请求default 默认路由 demoapp  v10子集\n# 默认浏览器类型\nroot@client /# curl demoapp:8080/user-agent\nUser-Agent: curl/7.67.0\n# 操纵发从下游的响应标头增加 X-Envoy: test\nroot@client /# curl -I demoapp:8080/user-agent\nHTTP/1.1 200 OK\ncontent-type: text/html; charset=utf-8\ncontent-length: 24\nserver: envoy\ndate: Fri, 04 Feb 2022 05:53:09 GMT\nx-envoy-upstream-service-time: 18\nx-envoy: test\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br"),e("span",{staticClass:"line-number"},[s._v("69")]),e("br"),e("span",{staticClass:"line-number"},[s._v("70")]),e("br"),e("span",{staticClass:"line-number"},[s._v("71")]),e("br"),e("span",{staticClass:"line-number"},[s._v("72")]),e("br"),e("span",{staticClass:"line-number"},[s._v("73")]),e("br"),e("span",{staticClass:"line-number"},[s._v("74")]),e("br"),e("span",{staticClass:"line-number"},[s._v("75")]),e("br"),e("span",{staticClass:"line-number"},[s._v("76")]),e("br"),e("span",{staticClass:"line-number"},[s._v("77")]),e("br"),e("span",{staticClass:"line-number"},[s._v("78")]),e("br"),e("span",{staticClass:"line-number"},[s._v("79")]),e("br"),e("span",{staticClass:"line-number"},[s._v("80")]),e("br"),e("span",{staticClass:"line-number"},[s._v("81")]),e("br"),e("span",{staticClass:"line-number"},[s._v("82")]),e("br"),e("span",{staticClass:"line-number"},[s._v("83")]),e("br"),e("span",{staticClass:"line-number"},[s._v("84")]),e("br"),e("span",{staticClass:"line-number"},[s._v("85")]),e("br"),e("span",{staticClass:"line-number"},[s._v("86")]),e("br"),e("span",{staticClass:"line-number"},[s._v("87")]),e("br"),e("span",{staticClass:"line-number"},[s._v("88")]),e("br"),e("span",{staticClass:"line-number"},[s._v("89")]),e("br"),e("span",{staticClass:"line-number"},[s._v("90")]),e("br")])]),e("h3",{attrs:{id:"_1-4、故障注入-测试服务韧性"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-4、故障注入-测试服务韧性"}},[s._v("#")]),s._v(" 1.4、故障注入 (测试服务韧性)")]),s._v(" "),e("h4",{attrs:{id:"_1-4-1、案例图示"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-1、案例图示"}},[s._v("#")]),s._v(" 1.4.1、案例图示")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://atlas.pingcode.com/files/public/6215b0579998feeb9ceef0d1",alt:"image.png"}})]),s._v(" "),e("h4",{attrs:{id:"_1-4-2、案例实验"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-4-2、案例实验"}},[s._v("#")]),s._v(" 1.4.2、案例实验")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("1、通过VirtualService 对demoapp进行故障注入测试\n# cat  virtualservice-demoapp.yaml\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: demoapp\nspec:\n  hosts:\n  - demoapp\n  http:\n  - name: canary\n    match:\n    - uri:\n        prefix: /canary\n    rewrite:\n      uri: /\n    route:\n    - destination:\n        host: demoapp\n        subset: v11\n    # 故障注入\n    fault:\n      # 故障类型 : 中断故障\n      abort:\n        # 在多大的流量上进行故障注入\n        percentage:\n          # 在百分之二十的流量上进行故障注入\n          value: 20\n        # 注入的故障响应给客户端的状态码 555\n        httpStatus: 555\n  - name: default\n    route:\n    - destination:\n        host: demoapp\n        subset: v10\n    # 故障注入\n    fault:\n      # 故障类型 : 延迟故障\n      delay:\n        # 在多大的流量上进行故障注入\n        percentage:\n          # 在百分之二十的流量上进行故障注入 3s 的延迟故障\n          value: 20\n        fixedDelay: 3s\n\n# kubectl apply -f virtualservice-demoapp.yaml\nvirtualservice.networking.istio.io/demoapp configured\n\n2、外部访问 proxy 调度给 demoapp v10 子集\n# default 延迟故障\ndaizhe@daizhedeMacBook-Pro ~ % while true; do curl fe.toptops.top:52212; sleep 0.$RANDOM; done\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-7fklt, ServerIP: 10.220.104.154!\n - Took 6 milliseconds.\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-ncnn6, ServerIP: 10.220.104.165!\n - Took 13 milliseconds.\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-7fklt, ServerIP: 10.220.104.154!\n - Took 3099 milliseconds.  # 如果流量基数够大可以观察到百分之二十的流量被注入了3s延迟\n\n3、集群内client 访问 frontend proxy调度给 demoapp v11子集 （补充 ：真正发挥网格流量调度的是 egress listener）\n# canary  中断故障\nroot@client /# while true; do curl proxy/canary; sleep 0.$RANDOM; done\nProxying value: fault filter abort - Took 1 milliseconds.\nProxying value: iKubernetes demoapp v1.1 !! ClientIP: 127.0.0.6, ServerName: demoappv11-7984f579f5-9pm74, ServerIP: 10.220.104.164!\n - Took 3 milliseconds.\nProxying value: iKubernetes demoapp v1.1 !! ClientIP: 127.0.0.6, ServerName: demoappv11-7984f579f5-msn2w, ServerIP: 10.220.104.159!\n - Took 4 milliseconds.\nProxying value: fault filter abort - Took 6 milliseconds. # 如果流量基数够大可以观察到百分之二十的流量被注入了中断故障,响应客户端状态码为 555\nProxying value: fault filter abort - Took 2 milliseconds.\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br")])]),e("ul",[e("li",[s._v("4、kiali graph能够根据流量实时进行图形绘制 (故障比例 20%)")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://atlas.pingcode.com/files/public/6215b1079434be138adfb96d",alt:"image.png"}})]),s._v(" "),e("h3",{attrs:{id:"_1-5、http-rerty-超时重试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-5、http-rerty-超时重试"}},[s._v("#")]),s._v(" 1.5、HTTP Rerty (超时重试)")]),s._v(" "),e("ul",[e("li",[s._v("请求重试的相关配置参数")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://atlas.pingcode.com/files/public/6215b1519434be138adfb96e",alt:"image.png"}})]),s._v(" "),e("ul",[e("li",[s._v("HTTP 请求重试条件 (route.RertyPlolicy)\n"),e("ul",[e("li",[s._v("重试条件 (同 x-envoy-retry-on 标头)\n"),e("ul",[e("li",[s._v("5xx : 上游主机返回5xx响应码，或者根本未予响应 (断开/重试/读取超时)；")]),s._v(" "),e("li",[s._v("gateway-error : 网关错误，类似于 5xx 策略，但仅为 502、503、504的应用进行重试；")]),s._v(" "),e("li",[s._v("connection-failure : 在TCP级别上与上游服务建立连接超时失败时进行重试；")]),s._v(" "),e("li",[s._v("retriable-4xx : 上游服务器返回可重复的4xx响应码时进行重试；")]),s._v(" "),e("li",[s._v("refused-stream : 上游服务使用REFUSED---stream 错误码重置时进行重试；")]),s._v(" "),e("li",[s._v("retriable-status-codes : 上游服务器的响应码与重试策略或者 x-envoy-retriable-status-codes 标头值中定义的响应码匹配时进行重试；")]),s._v(" "),e("li",[s._v("reset : 上游主机完全不响应时 (disconnect/reset/read 超时) ，Envoy将进行重试；")]),s._v(" "),e("li",[s._v("retriable-headers : 如果上游服务器响应报文匹配重试策略或 x-envoy-retriable-header-names 标头中包含的任何标头，则Envoy将尝试重试；")]),s._v(" "),e("li",[s._v("envoy-ratelimited : 标头中存在 x-envoy-ratelimited 时进行重试；")])])]),s._v(" "),e("li",[s._v("重试条件2 (同x-envoy-retry-grpc-on 标头)\n"),e("ul",[e("li",[s._v('cancelled : gRPC 应答标头中的状态码是 "cancelled" 时进行重试；')]),s._v(" "),e("li",[s._v('deadline-exceeded : gRPC 应答标头中的状态码是 "deadline-exceeded" 时进行重试；')]),s._v(" "),e("li",[s._v('internal : gRPC应答标头中的状态码是 "internal" 时进行重试；')]),s._v(" "),e("li",[s._v('resource-exhausted : gRPC应答标头中的状态码是 "resource-exhausted" 时进行重试；')]),s._v(" "),e("li",[s._v('unavailable : gRPC应答标头中的状态码是 "unavailable" 时进行重试；')])])]),s._v(" "),e("li",[s._v("默认情况下，Envoy不会将任何类型的重试操作重试，除非明确定义；")])])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('1、调整对 demoapp 访问的故障注入的故障比例 50%，以便 HTTP Rerty 更好查看效果 \n# cat virtualservice-demoapp.yaml\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: demoapp\nspec:\n  hosts:\n  - demoapp\n  http:\n  - name: canary\n    match:\n    - uri:\n        prefix: /canary\n    rewrite:\n      uri: /\n    route:\n    - destination:\n        host: demoapp\n        subset: v11\n    fault:\n      abort:\n        percentage:\n          value: 50\n        httpStatus: 555\n  - name: default\n    route:\n    - destination:\n        host: demoapp\n        subset: v10\n    fault:\n      delay:\n        percentage:\n          value: 50\n        fixedDelay: 3s\n\n# kubectl apply -f virtualservice-demoapp.yaml\n    virtualservice.networking.istio.io/demoapp configured\n\n2、集群外部访问通过 Gateway访问的真正调用 demoapp集群的客户端是 frontend proxy ，所以在 proxy之上增加了容错机制\n# 对 Ingress Gateway 给Proxy定义VirtualService \n# cat virtualservice-proxy.yaml\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: proxy\nspec:\n  # 用于定义哪个路由和虚拟主机有关系，所以需要指定hosts，此hosts必须和GW中hosts保持一致或者包含关系\n  hosts:\n  - "fe.toptops.top"                     # 对应于gateways/proxy-gateway\n  # (和网关相关联)  \n  # gateways用于指定该 vs 是定义在 Ingress Gateway 的接收入栈流量，并指定GW名称\n  gateways:\n  - istio-system/proxy-gateway       # 相关定义仅应用于Ingress Gateway上\n  #- mesh\n  # http 七层路由\n  http:\n  #  路由策略名称\n  - name: default\n    # 路由目标\n    route:\n    - destination:\n        # proxy cluster 是被自动生成的，因为集群内部有一个同名的Service，而且此集群在 ingess gateway 上本身存在\n        # 内部集群Service名称，但是流量不会直接发给Service，而是发给由Service组成的集群(这里的七层调度流量不再经由Service)\n        host: proxy     # proxy是要对demoapp 发起请求的\n    # 超时时长设置为 1s ，如果服务端要处理1s以上才会回复响应，则会立即响应客户端为超时；\n    timeout: 1s\n    # 重试策略\n    retries:\n      # 重试次数\n      attempts: 5\n      # 重试操作的超时时长，如果重试时超过1s以后则会响应客户端为超时；\n      perTryTimeout: 1s\n      # 重试的条件 : 对于后端服务端返回的 5xx 系列的响应状态码会转到retries 重试策略；\n      retryOn: 5xx,connect-failure,refused-stream\n\n# kubectl apply -f virtualservice-proxy.yaml\nvirtualservice.networking.istio.io/proxy configured\n\n3、集群外部进行访问 proxy测试\n# 外部访问 proxy 调度给 demoapp v10 子集 ，default 路由策略50%流量注入了延迟故障3s，如果请求超过1s则直接返回 upstream request timeout请求超时；\ndaizhe@daizhedeMacBook-Pro ~ % while true; do curl fe.toptops.top:52212; sleep 0.$RANDOM; done\nupstream request timeoutProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-qv9ws, ServerIP: 10.220.104.160!\n - Took 3 milliseconds.\nupstream request timeoutupstream request timeoutupstream request timeoutProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-ncnn6, ServerIP: 10.220.104.165!\n - Took 4 milliseconds.\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-7fklt, ServerIP: 10.220.104.154!\n - Took 32 milliseconds.\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-7fklt, ServerIP: 10.220.104.154!\n - Took 4 milliseconds.\n \n# 外部访问 proxy 调度给 demoapp v11 子集 ，canary 路由策略50%流量注入了中断故障并返回客户端状态码为 555，满足网关设置的重试策略，重试5次；\ndaizhe@daizhedeMacBook-Pro ~ % while true; do curl fe.toptops.top:52212/canary; sleep 0.$RANDOM; done\nProxying value: fault filter abort - Took 1 milliseconds.\nProxying value: fault filter abort - Took 2 milliseconds.\nProxying value: iKubernetes demoapp v1.1 !! ClientIP: 127.0.0.6, ServerName: demoappv11-7984f579f5-9pm74, ServerIP: 10.220.104.164!\n - Took 6 milliseconds.\nProxying value: iKubernetes demoapp v1.1 !! ClientIP: 127.0.0.6, ServerName: demoappv11-7984f579f5-msn2w, ServerIP: 10.220.104.159!\n - Took 6 milliseconds.\nProxying value: fault filter abort - Took 1 milliseconds.\nProxying value: fault filter abort - Took 2 milliseconds.\nProxying value: iKubernetes demoapp v1.1 !! ClientIP: 127.0.0.6, ServerName: demoappv11-7984f579f5-msn2w, ServerIP: 10.220.104.159!\n - Took 4 milliseconds.\n\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br"),e("span",{staticClass:"line-number"},[s._v("69")]),e("br"),e("span",{staticClass:"line-number"},[s._v("70")]),e("br"),e("span",{staticClass:"line-number"},[s._v("71")]),e("br"),e("span",{staticClass:"line-number"},[s._v("72")]),e("br"),e("span",{staticClass:"line-number"},[s._v("73")]),e("br"),e("span",{staticClass:"line-number"},[s._v("74")]),e("br"),e("span",{staticClass:"line-number"},[s._v("75")]),e("br"),e("span",{staticClass:"line-number"},[s._v("76")]),e("br"),e("span",{staticClass:"line-number"},[s._v("77")]),e("br"),e("span",{staticClass:"line-number"},[s._v("78")]),e("br"),e("span",{staticClass:"line-number"},[s._v("79")]),e("br"),e("span",{staticClass:"line-number"},[s._v("80")]),e("br"),e("span",{staticClass:"line-number"},[s._v("81")]),e("br"),e("span",{staticClass:"line-number"},[s._v("82")]),e("br"),e("span",{staticClass:"line-number"},[s._v("83")]),e("br"),e("span",{staticClass:"line-number"},[s._v("84")]),e("br"),e("span",{staticClass:"line-number"},[s._v("85")]),e("br"),e("span",{staticClass:"line-number"},[s._v("86")]),e("br"),e("span",{staticClass:"line-number"},[s._v("87")]),e("br"),e("span",{staticClass:"line-number"},[s._v("88")]),e("br"),e("span",{staticClass:"line-number"},[s._v("89")]),e("br"),e("span",{staticClass:"line-number"},[s._v("90")]),e("br"),e("span",{staticClass:"line-number"},[s._v("91")]),e("br"),e("span",{staticClass:"line-number"},[s._v("92")]),e("br"),e("span",{staticClass:"line-number"},[s._v("93")]),e("br"),e("span",{staticClass:"line-number"},[s._v("94")]),e("br"),e("span",{staticClass:"line-number"},[s._v("95")]),e("br"),e("span",{staticClass:"line-number"},[s._v("96")]),e("br"),e("span",{staticClass:"line-number"},[s._v("97")]),e("br"),e("span",{staticClass:"line-number"},[s._v("98")]),e("br"),e("span",{staticClass:"line-number"},[s._v("99")]),e("br"),e("span",{staticClass:"line-number"},[s._v("100")]),e("br"),e("span",{staticClass:"line-number"},[s._v("101")]),e("br"),e("span",{staticClass:"line-number"},[s._v("102")]),e("br"),e("span",{staticClass:"line-number"},[s._v("103")]),e("br"),e("span",{staticClass:"line-number"},[s._v("104")]),e("br")])]),e("ul",[e("li",[s._v("4、kiali graph能够根据流量实时进行图形绘制")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://atlas.pingcode.com/files/public/6215b223490a0657f83229f6",alt:"image.png"}})]),s._v(" "),e("h3",{attrs:{id:"_1-6、http-流量镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-6、http-流量镜像"}},[s._v("#")]),s._v(" 1.6、HTTP 流量镜像")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("1、调整对 demoapp 访问策略，增加流量镜像策略\n# cat virtualservice-demoapp.yaml\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: demoapp\nspec:\n  # 主机 ：对demoapp service 服务的访问\n  hosts:\n  - demoapp\n  # http 七层路由\n  http:\n  - name: traffic-mirror\n    # 路由目标，正常流量全部发往 demoapp v10 子集\n    route:\n    - destination:\n        host: demoapp\n        subset: v10\n    # 并将所有正常流量镜像一份到 demoapp v11 子集\n    mirror:\n      host: demoapp\n      subset: v11\n\n# kubectl apply -f virtualservice-demoapp.yaml\nvirtualservice.networking.istio.io/demoapp configured\n\n2、集群内client 访问 frontend proxy调度给 demoapp v10子集并镜像一份给  demoapp v11 子集（补充 ：真正发挥网格流量调度的是 egress listener）\nroot@client /# while true; do curl proxy; sleep 0.$RANDOM; done\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-ncnn6, ServerIP: 10.220.104.165!\n - Took 15 milliseconds.\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-7fklt, ServerIP: 10.220.104.154!\n - Took 8 milliseconds.\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-qv9ws, ServerIP: 10.220.104.160!\n - Took 8 milliseconds.\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-ncnn6, ServerIP: 10.220.104.165!\n - Took 3 milliseconds.\nProxying value: iKubernetes demoapp v1.0 !! ClientIP: 127.0.0.6, ServerName: demoappv10-5c497c6f7c-ncnn6, ServerIP: 10.220.104.165!\n - Took 8 milliseconds.\n\n# 外部访问 proxy \ndaizhe@daizhedeMacBook-Pro ~ % while true; do curl fe.toptops.top:52212; sleep 0.$RANDOM; done\n# 流量镜像需要从下面 kiali 查看\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br")])]),e("ul",[e("li",[s._v("3、kiali graph能够根据流量实时进行图形绘制")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://atlas.pingcode.com/files/public/6215b2a954aed604f0f8d795",alt:"image.png"}})])])}),[],!1,null,null,null);n.default=t.exports}}]);