<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Sidecar及流量拦截机制-上 | SRE运维充电站</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/images/favicon.svg">
    <script>var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?668842dc21c1b8f215b000531ec8f69e";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();</script>
    <meta name="description" content="这个杀手不太冷">
    <meta name="baidu_union_verify" content="a0036ccf0b657813fb236f80f376c429">
    <meta name="Keywords" content="Devops代哲,SRE运维充电站,pyenv.cc,Brains">
    <meta name="author" content="Devops代哲,SRE运维充电站,pyenv.cc,Brains">
    
    <link rel="preload" href="/assets/css/0.styles.938d6ff2.css" as="style"><link rel="preload" href="/assets/js/app.cd5fa041.js" as="script"><link rel="preload" href="/assets/js/3.ee7e7098.js" as="script"><link rel="preload" href="/assets/js/1.277d6ebc.js" as="script"><link rel="preload" href="/assets/js/38.6e6461a9.js" as="script"><link rel="prefetch" href="/assets/js/10.d3b54896.js"><link rel="prefetch" href="/assets/js/11.f4bb5601.js"><link rel="prefetch" href="/assets/js/12.ed610cd8.js"><link rel="prefetch" href="/assets/js/13.3a9eb8fa.js"><link rel="prefetch" href="/assets/js/14.b6ae182d.js"><link rel="prefetch" href="/assets/js/15.db6f82c2.js"><link rel="prefetch" href="/assets/js/16.3d5e10b6.js"><link rel="prefetch" href="/assets/js/17.471efd1e.js"><link rel="prefetch" href="/assets/js/18.832fe344.js"><link rel="prefetch" href="/assets/js/19.b59cbfac.js"><link rel="prefetch" href="/assets/js/20.472c4b66.js"><link rel="prefetch" href="/assets/js/21.800f456d.js"><link rel="prefetch" href="/assets/js/22.ffd207bc.js"><link rel="prefetch" href="/assets/js/23.323321ef.js"><link rel="prefetch" href="/assets/js/24.b9a5f746.js"><link rel="prefetch" href="/assets/js/25.60904ca4.js"><link rel="prefetch" href="/assets/js/26.fad8d09c.js"><link rel="prefetch" href="/assets/js/27.aaaa8f8c.js"><link rel="prefetch" href="/assets/js/28.d65a84c8.js"><link rel="prefetch" href="/assets/js/29.ce7bd2fb.js"><link rel="prefetch" href="/assets/js/30.f2c39de0.js"><link rel="prefetch" href="/assets/js/31.f02ef496.js"><link rel="prefetch" href="/assets/js/32.0889c36c.js"><link rel="prefetch" href="/assets/js/33.7b2efadd.js"><link rel="prefetch" href="/assets/js/34.4ff3296a.js"><link rel="prefetch" href="/assets/js/35.6b05b4ad.js"><link rel="prefetch" href="/assets/js/36.4322a33f.js"><link rel="prefetch" href="/assets/js/37.73e5620d.js"><link rel="prefetch" href="/assets/js/39.0b0071eb.js"><link rel="prefetch" href="/assets/js/4.6d9bb9fb.js"><link rel="prefetch" href="/assets/js/40.692bdf78.js"><link rel="prefetch" href="/assets/js/41.66cfe668.js"><link rel="prefetch" href="/assets/js/42.1b912be2.js"><link rel="prefetch" href="/assets/js/43.116e6cb6.js"><link rel="prefetch" href="/assets/js/44.00d176ef.js"><link rel="prefetch" href="/assets/js/45.06d1d798.js"><link rel="prefetch" href="/assets/js/46.43bfeb5c.js"><link rel="prefetch" href="/assets/js/47.735867da.js"><link rel="prefetch" href="/assets/js/48.12a1df49.js"><link rel="prefetch" href="/assets/js/5.99213a31.js"><link rel="prefetch" href="/assets/js/6.7a0b7b07.js"><link rel="prefetch" href="/assets/js/7.356b6533.js"><link rel="prefetch" href="/assets/js/8.9f6a6c22.js"><link rel="prefetch" href="/assets/js/9.832ff77d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.938d6ff2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-130b300a><div data-v-130b300a><div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-130b300a data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>SRE运维充电站</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>这个杀手不太冷</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>Brains</span>
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-130b300a><header class="navbar" data-v-130b300a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/favicon.svg" alt="SRE运维充电站" class="logo"> <span class="site-name">SRE运维充电站</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/HTML/" class="nav-link"><i class="undefined"></i>
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/categories/JavaScript/" class="nav-link"><i class="undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/categories/CSS/" class="nav-link"><i class="undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/categories/Go/" class="nav-link"><i class="undefined"></i>
  Go
</a></li><li class="dropdown-item"><!----> <a href="/categories/Docker/" class="nav-link"><i class="undefined"></i>
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/categories/Kubernetes/" class="nav-link"><i class="undefined"></i>
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/categories/Monitoring/" class="nav-link"><i class="undefined"></i>
  Monitoring
</a></li><li class="dropdown-item"><!----> <a href="/categories/ServiceMesh/" class="nav-link"><i class="undefined"></i>
  ServiceMesh
</a></li><li class="dropdown-item"><!----> <a href="/categories/Vue/" class="nav-link"><i class="undefined"></i>
  Vue
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-tools"></i>
      工具箱
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.uupoop.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  在线PS
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://cowtransfer.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  奶牛快传
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.tiobe.com/tiobe-index/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  编程语言排行榜
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      关于
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/views/About/resume.html" class="nav-link"><i class="iconfont reco-document"></i>
  简历
</a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/weixin_41989934" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-csdn"></i>
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Dz6666" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/Dz6666" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-130b300a></div> <aside class="sidebar" data-v-130b300a><div class="personal-info-wrapper" data-v-39576ba9 data-v-130b300a><img src="/images/head_portrait.svg" alt="author-avatar" class="personal-img" data-v-39576ba9> <h3 class="name" data-v-39576ba9>
    Brains
  </h3> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>30</h3> <h6 data-v-39576ba9>Articles</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>16</h3> <h6 data-v-39576ba9>Tags</h6></div></div> <ul class="social-links" data-v-39576ba9></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      分类
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/HTML/" class="nav-link"><i class="undefined"></i>
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/categories/JavaScript/" class="nav-link"><i class="undefined"></i>
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/categories/CSS/" class="nav-link"><i class="undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/categories/Go/" class="nav-link"><i class="undefined"></i>
  Go
</a></li><li class="dropdown-item"><!----> <a href="/categories/Docker/" class="nav-link"><i class="undefined"></i>
  Docker
</a></li><li class="dropdown-item"><!----> <a href="/categories/Kubernetes/" class="nav-link"><i class="undefined"></i>
  Kubernetes
</a></li><li class="dropdown-item"><!----> <a href="/categories/Monitoring/" class="nav-link"><i class="undefined"></i>
  Monitoring
</a></li><li class="dropdown-item"><!----> <a href="/categories/ServiceMesh/" class="nav-link"><i class="undefined"></i>
  ServiceMesh
</a></li><li class="dropdown-item"><!----> <a href="/categories/Vue/" class="nav-link"><i class="undefined"></i>
  Vue
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont icon-tools"></i>
      工具箱
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.uupoop.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  在线PS
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://cowtransfer.com/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  奶牛快传
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://www.tiobe.com/tiobe-index/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  编程语言排行榜
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      关于
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/views/About/resume.html" class="nav-link"><i class="iconfont reco-document"></i>
  简历
</a></li><li class="dropdown-item"><!----> <a href="https://blog.csdn.net/weixin_41989934" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-csdn"></i>
  CSDN
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/Dz6666" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://gitee.com/Dz6666" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-mayun"></i>
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>Sidecar及流量拦截机制-上</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>Brains</span>
            
          <!---->
          2022
        </a></span></div></div> <div data-v-130b300a><main class="page"><section><div class="page-title"><h1 class="title">Sidecar及流量拦截机制-上</h1> <div data-v-f875f3fc><i class="iconfont reco-account" data-v-f875f3fc><span data-v-f875f3fc>Brains</span></i> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>3/16/2022</span></i> <i class="iconfont reco-eye" data-v-f875f3fc><span id="/views/Official_Accounts/Sidecar%E5%8F%8A%E6%B5%81%E9%87%8F%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%88%B6-%E4%B8%8A.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-f875f3fc><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-f875f3fc><span class="tag-item" data-v-f875f3fc>Istio</span></i></div></div> <div class="theme-reco-content content__default"><div class="custom-block tip"><p class="title"></p><p><img src="https://atlas.pingcode.com/files/public/623716afb57b01cedea524e5" alt="image.png"></p></div> <p></p><div class="table-of-contents"><ul><li><a href="#一、istio环境中运行pod的要求">一、Istio环境中运行Pod的要求</a></li><li><a href="#二、协议选择-protocol-selection">二、协议选择 (Protocol Selection)</a></li><li><a href="#三、sidecar代理方式简介">三、Sidecar代理方式简介</a></li><li><a href="#四、sidecar-envoy-流量劫持">四、Sidecar Envoy  流量劫持</a></li><li><a href="#五、istio注入的envoy-sidecar">五、Istio注入的Envoy Sidecar</a><ul><li><a href="#_5-1、istio-init初始化容器">5.1、istio-init初始化容器</a></li><li><a href="#_5-2、istio-proxy-容器">5.2、istio-proxy 容器</a></li><li><a href="#_5-3、istio-proxy-clusters">5.3、istio-proxy Clusters</a></li></ul></li></ul></div><p></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/a876ce53880f048106d1ffedd8ae71a2.png" alt="⭐️关注我 ，一起探索更多知识！⭐️"></p> <p><em>更多相关文章</em></p> <p><a href="https://mp.weixin.qq.com/s?__biz=Mzg3NzY0NjY5OQ==&amp;mid=2247484127&amp;idx=1&amp;sn=d819cfded9102b9a16d8a58070d75ac7&amp;chksm=cf1e84dbf8690dcde5d2c47d4073b0a0aaa79b57521a845b2d387fb063bab8ab4e6cad991754#rd" target="_blank" rel="noopener noreferrer">ServiceMesh基本概念<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://mp.weixin.qq.com/s?__biz=Mzg3NzY0NjY5OQ==&amp;mid=2247484137&amp;idx=1&amp;sn=65fbe4f279521a4d0de75692719b7475&amp;chksm=cf1e84edf8690dfb9c6adf7788c77613e1f3776b47547a281860f627f2ea5077f7ef8cb97a45#rd" target="_blank" rel="noopener noreferrer">手把手教你部署istio控制平面<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://mp.weixin.qq.com/s?__biz=Mzg3NzY0NjY5OQ==&amp;mid=2247484163&amp;idx=1&amp;sn=d0d4eaab73dc8e950e46a789e4f40fb3&amp;chksm=cf1e8507f8690c112fb75c5b99558eb15e4e8de9bf89e166bcd15304c74f7b55bedb97c8b77e&amp;token=414749856&amp;lang=zh_CN#rd" target="_blank" rel="noopener noreferrer">四个案例让你掌握istio网格功能<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://mp.weixin.qq.com/s?__biz=Mzg3NzY0NjY5OQ==&amp;mid=2247484245&amp;idx=1&amp;sn=859b0808beebc3fe660bc398ce4ffc68&amp;chksm=cf1e8551f8690c47d435732e654890c105644d57d5175c01f74f892d0a6cdcb23db120c3c1bd#rd" target="_blank" rel="noopener noreferrer">VirtualService实现Istio高级流量治理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="http://mp.weixin.qq.com/s?__biz=Mzg3NzY0NjY5OQ==&amp;mid=2247484270&amp;idx=1&amp;sn=bce9568d5782b15bf718257ade445918&amp;chksm=cf1e856af8690c7cffce92758098cebf68e15759859e54ec040e9bc26b79afe250fda320b44b&amp;token=729952560&amp;lang=zh_CN#rd" target="_blank" rel="noopener noreferrer">DestinationRule实现Istio集群高级配置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="一、istio环境中运行pod的要求"><a href="#一、istio环境中运行pod的要求" class="header-anchor">#</a> 一、Istio环境中运行Pod的要求</h2> <ul><li>Service association （服务关联）</li> <li>Pod 必须从属于某个Service，哪怕Pod不需要暴露任何端口，否则此Pod就是一个无Service的Pod，会导致网格内部无法于相关的Sidecar进行关联；</li> <li>同时从属于多个Service时，这些Service不能为该类Pod的同一个端口标识使用不同的协议；</li> <li>Application UIDs</li> <li>UID 1337 预留给了Sidecar Proxy 使用，业务应用不能以这一 UID 运行；</li> <li>NET_ADMIN and NET_RAW capabilities</li> <li>强制启用了PSP（Pod Security Policy）的Kubernetes环境中，必须允许在网格内的Pod上使用NET_ADMIN和 NET_RAW这两个Capability，以确保Sidecar Envoy依赖的初始化Pod能够正常运行；</li> <li>未启用PSP，或者启用了PSP但使用了专用的Istio CNI Plugin的场景，可以不用；</li> <li>Pods with app and version labels （部署在网格内的每一个应用程序都需要明确使用以下两个标签）</li> <li>显式地为 Pod使用app和version标签；</li> <li>app标签用于为分布式追踪生成context，而label则用于指示应用的版本化；</li> <li>Named Service Ports (为网格内的每一个Service的端口定义一个名称及明确其协议)</li> <li>Service Port 应该明确指定使用的协议；</li> <li>命名格式 ：
<ul><li>[-]   如  http-8080</li> <li>Kubernetes v1.18 及之后的版本中，可以直接使用 appProtocol 字段进行标识；</li></ul></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code># 网格会依赖对应方式指定的协议标识作为协议，即应用程序对外提供服务协议的特定标识；这也是Envoy在代理应用程序基于的协议类型；

1、&lt;protocol&gt;[-&lt;suffix&gt;] 格式
apiVersion: v1
kind: Service
metadata:
  name: demoappv10
spec:
  ports:
    - name: http-8080
      port: 8080
      protocol: TCP
      targetPort: 8080
  selector:
    app: demoapp
    version: v1.0
  type: ClusterIP

2、Kubernetes v1.18 及之后的版本中，可以直接使用 appProtocol 字段进行标识
apiVersion: v1
kind: Service
metadata:
  name: demoappv10
spec:
  appProtocol: http
  ports:
    - name: http
      port: 8080
      protocol: TCP
      targetPort: 8080
  selector:
    app: demoapp
    version: v1.0
  type: ClusterIP
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p></p> <h2 id="二、协议选择-protocol-selection"><a href="#二、协议选择-protocol-selection" class="header-anchor">#</a> 二、协议选择 (Protocol Selection)</h2> <ul><li>Istio 支持代理的协议
<ul><li>支持代理任何类型的TCP流量，包括HTTP、HTTPS、gRPC及原始TCP(raw tcp) 协议；</li> <li>但为了提供额外的能力，比如路由和更加丰富的指标，Istio需要确定更加具体的协议( 应用层协议) ；</li> <li>Istio不会代理任何UDP协议；</li></ul></li> <li>协议选择
<ul><li>istio 能够自动检测并识别 HTTP和HTTP/2 的流量，未检测出的协议类型将一律视为普通的TCP流量；</li> <li>也支持由用户手动指定；</li></ul></li> <li>手动指定协议
<ul><li>Service Port 应该明确指定使用的协议；</li> <li>命名格式 :
<ul><li>[-]</li> <li>Kubernetes v1.18 及之后的版本中，可以直接使用 appProtocol 字段进行标识；</li></ul></li></ul></li> <li>Istio支持的协议类型如下 ：</li></ul> <blockquote><p>https://istio.io/latest/docs/ops/configuration/traffic-management/protocol-selection/</p></blockquote> <p><img src="https://img-blog.csdnimg.cn/img_convert/0702889f582610dfcd94d1327da9baec.png" alt="image.png"></p> <p></p> <h2 id="三、sidecar代理方式简介"><a href="#三、sidecar代理方式简介" class="header-anchor">#</a> 三、Sidecar代理方式简介</h2> <ul><li>Kubernetes平台上，Envoy Sidecar容器与application容器于同一个Pod中共存，它们共享 NETWORK、UTS和IPC等名称空间，因此也共用同一个网络协议栈；
<ul><li>Envoy Sidecar 基于 init 容器 (需要使用 NET_ADMIN 和 NET_RAW Capability 于 Pod启动时设置的 iptables规则以实现流量拦截)
<ul><li>入站流量由iptables拦截后转发给Envoy；</li> <li>Envoy根据配置完成入栈流量代理；</li> <li>后端应用程序生成的出站流量依然由iptables拦截并转发给Envoy；</li> <li>Envoy 根据配置完成出站流量代理；</li></ul></li></ul></li> <li>流量拦截模式
<ul><li>REDIRECT : 重定向模式</li> <li>TPROXY : 透明代理模式
<ul><li>具体操作参考 :  https://github.com/istio/istio/blob/master/tools/packaging/common/istio-start.sh</li></ul></li></ul></li></ul> <h2 id="四、sidecar-envoy-流量劫持"><a href="#四、sidecar-envoy-流量劫持" class="header-anchor">#</a> 四、Sidecar Envoy  流量劫持</h2> <ul><li>流量的透明劫持
<ul><li>流量的透明劫持，用于确保让应用无需事先改造即可获得服务治理和观测能力；</li> <li>开启透明劫持功能后，出入应用的业务流量将会被Sidecar Envoy自动拦截；</li></ul></li></ul> <p><img src="https://img-blog.csdnimg.cn/img_convert/d2fde3de123510af5efa59befb36de07.png" alt="image.png"></p> <p></p> <h2 id="五、istio注入的envoy-sidecar"><a href="#五、istio注入的envoy-sidecar" class="header-anchor">#</a> 五、Istio注入的Envoy Sidecar</h2> <ul><li>Istio 基于 Kubernetes Admission Controller Webhook 完成sidecar自动注入，它会为每个微服务分别添加两个相关的容器；
<ul><li>istio-init : 隶属于 Init Containers ，即初始化容器，负责在微服务相关的Pod中 生成iptables规则 以进行流量拦截并向Envoy Proxy进行转发，运行完成后退出；</li> <li>istio-proxy : 隶属于Contianers, 即Pod中的正常容器，程序为 Envoy Proxy；</li></ul></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code># 查看每个Pod上是如何指定注入的 istio init container
# Init Containers 生成流量劫持规则
Init Containers:
  istio-init:
    Container ID:  docker://943e9512f4e3ec0f64b25b26ac334c70800169416389abc58b723413481c787f
    Image:         docker.io/istio/proxyv2:1.12.1
    Image ID:      docker-pullable://istio/proxyv2@sha256:4704f04f399ae24d99e65170d1846dc83d7973f186656a03ba70d47bd1aba88f
    Port:          &lt;none&gt;
    Host Port:     &lt;none&gt;
    Args:
      istio-iptables
      # 入向流量生成规则的重定向端口
      -p
      15001
      # 出向流量端口
      -z
      15006
      # 使用用户UID
      -u
      1337
      -m
      REDIRECT
      -i
      *
      -x

      -b
      *
      -d
      15090,15021,15020
...
Containers:
  demoapp:
    Container ID:   docker://563a48b833baf3ab46ef35f147012e124ba3c114323377c261f2cb5c8729a34f
    Image:          ikubernetes/demoapp:v1.0
    Image ID:       docker-pullable://ikubernetes/demoapp@sha256:6698b205eb18fb0171398927f3a35fe27676c6bf5757ef57a35a4b055badf2c3
    Port:           &lt;none&gt;
    Host Port:      &lt;none&gt;
...
# istio-proxy: 真正意义上流量治理 sidecar envoy
  istio-proxy:
    Container ID:  docker://bab78cd8993123c8a24a236a02a0b572a3acbc0e013559a24dd57959d9c7430c
    Image:         docker.io/istio/proxyv2:1.12.1
    Image ID:      docker-pullable://istio/proxyv2@sha256:4704f04f399ae24d99e65170d1846dc83d7973f186656a03ba70d47bd1aba88f
    Port:          15090/TCP
    Host Port:     0/TCP
    Args:
      proxy
      sidecar   # sidecar 模式运行
      --domain
      $(POD_NAMESPACE).svc.cluster.local
      --proxyLogLevel=warning
      --proxyComponentLogLevel=misc:error
      --log_output_level=default:info
      --concurrency
      2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p></p> <h3 id="_5-1、istio-init初始化容器"><a href="#_5-1、istio-init初始化容器" class="header-anchor">#</a> 5.1、istio-init初始化容器</h3> <ul><li>istio-init初始化容器基于 istio/proxyv2 镜像启动，它运行 istio-iptables 程序以生成流量拦截规则
<ul><li>拦截的流量将转发至两个相关的端口
<ul><li>15006 ：由 -z 选项定义，指定用于接收拦截所有发往当前Pod/VM的入栈流量的目标端口，该配置仅用于 REDIRECT 转发模式；</li> <li>15001 ：由 -p 选项定义，指定用于接收拦截的所有TCP流量的目标端口；</li></ul></li> <li>流量拦截模式由 -m 选项指定，目前支持 REDIRECT 和 TPROXY 两种模式；</li> <li>流量拦截时要包含的目标端口列表使用 -b 选项指定，而要排除的目标端口列表则使用 -d 选项指定；</li> <li>流量拦截时要包含的目标 CIDR 地址列表可使用 -i 选项指定，而要排除的目标 CIDR 格式的地址列表则使用 -x 选项指定；</li></ul></li></ul> <h4 id="_5-1-1、istio中用于流量拦截的iptables规则"><a href="#_5-1-1、istio中用于流量拦截的iptables规则" class="header-anchor">#</a> 5.1.1、istio中用于流量拦截的iptables规则</h4> <ul><li>nsenter 命令于宿主机上可直接于目标容器的网络名称空间中运行 iptables 命令，例如，假设 productpage 相关的 Pod被调度运行于 k8s-node02 节点之上，且其内部的 envoy 进程的 pid在宿主机为 5607 ;</li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code># 对应运行envoy sidecar 节点上运行命令
root@native:~# ps aux | grep envoy | grep 1337
root@native:~# nsenter -t 8134 -n iptables -t nat -S
-P PREROUTING ACCEPT
-P INPUT ACCEPT
-P OUTPUT ACCEPT
-P POSTROUTING ACCEPT
-N ISTIO_INBOUND
-N ISTIO_IN_REDIRECT
-N ISTIO_OUTPUT
-N ISTIO_REDIRECT
-A PREROUTING -p tcp -j ISTIO_INBOUND
-A OUTPUT -p tcp -j ISTIO_OUTPUT
-A ISTIO_INBOUND -p tcp -m tcp --dport 15008 -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport 22 -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport 15090 -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport 15021 -j RETURN
-A ISTIO_INBOUND -p tcp -m tcp --dport 15020 -j RETURN
-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT
-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006
-A ISTIO_OUTPUT -s 127.0.0.6/32 -o lo -j RETURN
-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT
-A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN
-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT
-A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN
-A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN
-A ISTIO_OUTPUT -j ISTIO_REDIRECT
-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><h4 id="_5-1-2、流量拦截的处理机制"><a href="#_5-1-2、流量拦截的处理机制" class="header-anchor">#</a> 5.1.2、流量拦截的处理机制</h4> <ul><li>入向流量拦截 : PREROUTING -&gt; ISTIO_INBOUND
<ul><li>RETURN
<ul><li>目标端口为 TCP 协议的 22、15020、15021、15008、15090 时将报文返回至上级 PREROUTING 链，即不予拦截；</li></ul></li> <li>ISTIO_IN_REDIRECT : 其它目标端口的请求报文则由该自定链中的规则 (-A ISTIO_IN_REDIRECT -p tcp -j RESIRECT --to-ports 15006) 将请求重定向至 15006 端口；
<ul><li>15006 端口时为 envoy 的 VirtualInboundListener 绑定的端口，于是请求则转交由Envoy处理；</li> <li>Envoy 根据报文目标地址匹配入向 (Inbound) 方向的Listener，若存在，则根据该 Listener的配置决定如何将请求转发至 Envoy后端的应用程序；</li></ul></li></ul></li></ul> <p><img src="https://img-blog.csdnimg.cn/img_convert/76c2d70f2aa2b0c47d34d9748c5b790c.png" alt="image.png"></p> <p></p> <ul><li>出向流量拦截 : OUTPUT -&gt; ISTIO_OUTPUT
<ul><li>RETURN
<ul><li>从 LO 接口流出，且源地址为 127.0.0.6/32 的出向流量</li> <li>UID Owner 为 1337 的出向流量</li> <li>GID Owner 为 1337 的出向流量</li> <li>从 LO 接口流出，且UID Owner 非为 1337 的出向流量</li> <li>从 LO 接口流出，且GID Owner 非为 1337 的出向流量</li> <li>目标地址是 127.0.0.1/32 的出向流量</li></ul></li> <li>ISTIO_IN_REDIRECT : Sidecar Envoy 同其反向代理的本地后端应用程序间的通信
<ul><li>从 LO 接口流出，目标地址非为 127.0.0.1/32，且UID Owner 为 1337 的出向流量</li> <li>从 LO 接口流出，目标地址非为 127.0.0.1/32，且GID Owner 为 1337 的出向流量</li></ul></li></ul></li> <li>ISTIO_REDIRECT：其它报文则由该自定义链中的规则（-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001）重定向至15001端口；
<ul><li>Envoy根据报文目标地址匹配出向（Outbound）方向的Listener，若存在，则 根据该Listener的配置决定如何将报文向外转发；</li></ul></li></ul> <p><img src="https://img-blog.csdnimg.cn/img_convert/109ad5e3a43341cac1ccf3720ea2dbea.png" alt="image.png"></p> <p></p> <h3 id="_5-2、istio-proxy-容器"><a href="#_5-2、istio-proxy-容器" class="header-anchor">#</a> 5.2、istio-proxy 容器</h3> <ul><li>istio-proxy即所谓的sidecar容器，它运行两个进程:
<ul><li>pilot-agent</li> <li>基于k8s api server 为 envoy 初始化出可用的 bootstrap 配置文件并启动envoy;</li> <li>监控并管理envoy的运行状态，包括envoy出错时重启envoy，以及envoy配置变更后将其重载等；</li> <li>envoy</li> <li>envoy 由pilot-agent 进程基于生成bootstrap 配置进行启动，而后根据配置中指定的 pilot 地址，通过xDS API获取动态配置信息；</li> <li>Sidecar形式的Envoy通过流量拦截机制为应用程序实现入站和出站代理功能；</li></ul></li></ul> <div class="language- line-numbers-mode"><pre class="language-text"><code># kubectl exec demoappv10-6ff964cbff-84kqr -it -c istio-proxy -- ps aux
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
istio-p+     1  0.1  0.4 747732 47700 ?        Ssl  Feb19   0:50 /usr/local/bin/pilot-agent proxy sidecar --domain default.svc.cluster.local --proxyLogLevel=
istio-p+    28  0.4  0.5 185544 58488 ?        Sl   Feb19   3:16 /usr/local/bin/envoy -c etc/istio/proxy/envoy-rev0.json --restart-epoch 0 --drain-time-s 45
istio-p+    42  0.0  0.0   5900  2804 pts/0    Rs+  03:45   0:00 ps aux
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p></p> <h4 id="_5-2-1、istio-proxy-容器及其listener"><a href="#_5-2-1、istio-proxy-容器及其listener" class="header-anchor">#</a> 5.2.1、istio-proxy 容器及其Listener</h4> <ul><li>Envoy 的bootstrap 配合文件由pilot-agent 负责生成，而生效的大多配置则定义了dynamic resources ，并通过xDS静态集群指向的Plot 获取；
<ul><li>而这些配置则来自于 VirtaulService、DestinationRule、Gateway和ServiceEntry资源对象等提供的配置；</li></ul></li> <li>由Pilot基于Kubernetes发现的网格内的各Service均会被自动转换为下发给各Sidecar实例的Listener、Route、Cluster和Endpoint的相关配置；
<ul><li>为了能够让Sidecar Envoy代理网格内进出各Service的流量，所以需要进行流量劫持，而后由Envoy根据请求特征，将流量派发至合适的Listener，进而完成后续的流量路由、负载均衡等；</li></ul></li></ul> <h4 id="_5-2-2、istio-proxy-listener-几个重要侦听器的作用"><a href="#_5-2-2、istio-proxy-listener-几个重要侦听器的作用" class="header-anchor">#</a> 5.2.2、istio-proxy Listener (几个重要侦听器的作用)</h4> <ul><li>Envoy Listener 支持绑定于 IP Socket 或 Unix Domain Socket 之上，也可以不予绑定，而是接收由其他的Listener转发来的数据；
<ul><li>VirtualOutboundListener</li> <li>通过一个端口接收所有的出口流量，而后再按照请求的端口分别转发给相应的 Listener进行处理；</li> <li>VirtualInboundListner</li> <li>功能相似，但主要用于处理入向流量；</li></ul></li></ul> <p>VirtualOutboundListener(不过多展开)</p> <ul><li>iptables 将其所在的Pod中的外发流量拦截后转发至监听于15001的Listener，而该Listener通过在配置中将 use_origin_dest 参数设置为true，从而实现将接收到的请求转发给同请求原目标地址关联的Listener之上；</li> <li>若不存在可接收转发报文的Listener，则Envoy将根据Istio的全局配置选项 outboundTrafficPolicy 参数的值决定如何进行处理 :
<ul><li>ALLOW_ANY :</li> <li>允许外发至任何服务的请求，无论目标服务是否存在于Pilot的注册表中；此时，没有匹配的目标Listener的流量将由该侦听器上 tcp_proxy 过滤器指向的 Passthrouh Cluster 进行透传；</li> <li>REGISTRY_ONLY :</li> <li>仅允许外发请求至注册与Polit 中的服务；此时，没有匹配的目标Listener的流量将由该侦听器上 tcp_proxy 过滤器指向的 BlackHoleCluster 将流量直接丢弃；</li></ul></li> <li>出向流量劫持方式总结 :
<ul><li>所有应用的出向流量会被重定向给 Envoy Sidecar 的 15001 侦听器，而后 15001 侦听器将流量根据其请求的原有的目标IP和目标端口来在Envoy中找出真正于该流量相关的出站侦听器，再把其请求转交至其真正相关的出站侦听器；若其没有找到对应条件的出站侦听器则根据出站流量策略 outboundTrafficPolicy 确定是交给 Passthrouh Cluster 进行透传还是 BlackHoleCluster 进行丢弃；</li></ul></li></ul> <p>VirtualInbound Listener(不过多展开)</p> <ul><li>入向流量劫持
<ul><li>较早版本的 Istio 基于同一个 VirtualListener 在 15001 端口上同时处理入站和出站流量；</li> <li>自 1.4 版本起，Istio引入了 REDIRECT 代理模式，它通过监听于 15006 端口 的专用 VirtualInboundListener 处理入向流量代理以避免潜在的死循环问题；</li></ul></li> <li>入向流量处理
<ul><li>对于进入到 侦听器 &quot;0.0.0.0:15006&quot; 的流量，VirtaulInboundListener 会在 filterChains 中，通过一系列的 filter_chain_match 对流量进行匹配检测，以确定应该由哪个或哪些过滤器进行流量处理；</li></ul></li> <li>入向流量劫持方式总结
<ul><li>istio proxy 对所有相关入向流量的处理方式是所有请求的无论目标 APP服务监听的端口，Envoy 都不会为其在前端创建入站侦听器而是所有流量交给 15006 ，在15006入站侦听器内部 都会通过 filter_chain_match 进行处理，然后通过其内部 filterChainMatch 进行匹配，而后又经过filter进行流量转发；</li></ul></li></ul> <h3 id="_5-3、istio-proxy-clusters"><a href="#_5-3、istio-proxy-clusters" class="header-anchor">#</a> 5.3、istio-proxy Clusters</h3> <ul><li>Istio 网格中的Cluster分别由 static_resources 提供的静态配置集群以及 dynamic_resources 提供的动态配置集群组成；
<ul><li>静态集群由 envoy_rev0.json 的初始化配置中的 prometheus_stats 、xDS server 和zipkin server等组成；</li> <li>动态集群则是由通过xDS API 从Pilot获取的配置信息生成；</li></ul></li> <li>对于网格内的一个特定Pod来说，其集群可主要分为两类 :
<ul><li>inbound : 该Pod内的Sidecar Envoy直接代理的服务；</li> <li>outbound : 网格内的所有服务；</li></ul></li> <li>动态集群类型
<ul><li>Inbound Cluster ：Sidecar Envoy直接代理的应用，同一Pod中，由Sidecar Envoy反向代理的应用容器；</li> <li>Outbound Cluster ：网格中的所有服务，包括当前Sidecar Envoy直接代理的服务，该类Cluster占了Envoy可用集 群中的绝大多数；</li> <li>PassthroughCluster和InboundPassthroughClusterIpv4 ：发往此类集群的请求报文会被直接透传至其请求中的原 始目标地址，Envoy不会进行重新路由；</li> <li>BlackHoleCluster ：Envoy的一个特殊集群，它没有任何可用的endpoint，接收到的请求会被直接丢弃；未能正 确匹配到目标服务的请求通常会被发往此Cluster；</li></ul></li></ul></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-cb1513f6><li class="level-2" data-v-cb1513f6><a href="/views/Official_Accounts/Sidecar%E5%8F%8A%E6%B5%81%E9%87%8F%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%88%B6-%E4%B8%8A.html#一、istio环境中运行pod的要求" class="sidebar-link reco-side-一、istio环境中运行pod的要求" data-v-cb1513f6>一、Istio环境中运行Pod的要求</a></li><li class="level-2" data-v-cb1513f6><a href="/views/Official_Accounts/Sidecar%E5%8F%8A%E6%B5%81%E9%87%8F%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%88%B6-%E4%B8%8A.html#二、协议选择-protocol-selection" class="sidebar-link reco-side-二、协议选择-protocol-selection" data-v-cb1513f6>二、协议选择 (Protocol Selection)</a></li><li class="level-2" data-v-cb1513f6><a href="/views/Official_Accounts/Sidecar%E5%8F%8A%E6%B5%81%E9%87%8F%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%88%B6-%E4%B8%8A.html#三、sidecar代理方式简介" class="sidebar-link reco-side-三、sidecar代理方式简介" data-v-cb1513f6>三、Sidecar代理方式简介</a></li><li class="level-2" data-v-cb1513f6><a href="/views/Official_Accounts/Sidecar%E5%8F%8A%E6%B5%81%E9%87%8F%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%88%B6-%E4%B8%8A.html#四、sidecar-envoy-流量劫持" class="sidebar-link reco-side-四、sidecar-envoy-流量劫持" data-v-cb1513f6>四、Sidecar Envoy  流量劫持</a></li><li class="level-2" data-v-cb1513f6><a href="/views/Official_Accounts/Sidecar%E5%8F%8A%E6%B5%81%E9%87%8F%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%88%B6-%E4%B8%8A.html#五、istio注入的envoy-sidecar" class="sidebar-link reco-side-五、istio注入的envoy-sidecar" data-v-cb1513f6>五、Istio注入的Envoy Sidecar</a></li><li class="level-3" data-v-cb1513f6><a href="/views/Official_Accounts/Sidecar%E5%8F%8A%E6%B5%81%E9%87%8F%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%88%B6-%E4%B8%8A.html#_5-1、istio-init初始化容器" class="sidebar-link reco-side-_5-1、istio-init初始化容器" data-v-cb1513f6>5.1、istio-init初始化容器</a></li><li class="level-3" data-v-cb1513f6><a href="/views/Official_Accounts/Sidecar%E5%8F%8A%E6%B5%81%E9%87%8F%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%88%B6-%E4%B8%8A.html#_5-2、istio-proxy-容器" class="sidebar-link reco-side-_5-2、istio-proxy-容器" data-v-cb1513f6>5.2、istio-proxy 容器</a></li><li class="level-3" data-v-cb1513f6><a href="/views/Official_Accounts/Sidecar%E5%8F%8A%E6%B5%81%E9%87%8F%E6%8B%A6%E6%88%AA%E6%9C%BA%E5%88%B6-%E4%B8%8A.html#_5-3、istio-proxy-clusters" class="sidebar-link reco-side-_5-3、istio-proxy-clusters" data-v-cb1513f6>5.3、istio-proxy Clusters</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><!----><div class="kanbanniang" data-v-5775ee02><div class="banniang-container" style="display:;" data-v-5775ee02><div class="messageBox" style="right:68px;bottom:190px;display:none;" data-v-5775ee02>
      我是Brains,欢迎你的关注 
    </div> <div class="operation" style="right:90px;bottom:40px;display:;" data-v-5775ee02><i class="kbnfont kbn-ban-home ban-home" data-v-5775ee02></i> <i class="kbnfont kbn-ban-message message" data-v-5775ee02></i> <i class="kbnfont kbn-ban-close close" data-v-5775ee02></i> <a target="_blank" href="https://vuepress-theme-reco.recoluan.com/views/plugins/kanbanniang.html" data-v-5775ee02><i class="kbnfont kbn-ban-info info" data-v-5775ee02></i></a> <i class="kbnfont kbn-ban-theme skin" style="display:;" data-v-5775ee02></i></div> <canvas id="banniang" width="200px" height="250" class="live2d" style="right:90px;bottom:-20px;opacity:0.9;" data-v-5775ee02></canvas></div> <div class="showBanNiang" style="display:none;" data-v-5775ee02>
    看板娘
  </div></div><canvas id="vuepress-canvas-cursor"></canvas><!----></div></div>
    <script src="/assets/js/app.cd5fa041.js" defer></script><script src="/assets/js/3.ee7e7098.js" defer></script><script src="/assets/js/1.277d6ebc.js" defer></script><script src="/assets/js/38.6e6461a9.js" defer></script>
  </body>
</html>
